<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CattoEPUB ‚Äî PDF to EPUB Converter (Thai)</title>
<meta name="description" content="‡πÅ‡∏õ‡∏•‡∏á PDF ‡πÄ‡∏õ‡πá‡∏ô EPUB ‡∏î‡πâ‡∏ß‡∏¢ Typhoon OCR ‚Äî ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üê±</text></svg>">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6FA8DD">
<!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4625693104435293" crossorigin="anonymous"></script>
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DBTHGF25YB"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-DBTHGF25YB');</script>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Kanit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}

:root{
  --bg:#f8fafc;
  --bg2:#f1f5f9;
  --white:#ffffff;
  --border:#e2e8f0;
  --border2:#cbd5e1;
  --text:#0f172a;
  --text2:#475569;
  --text3:#94a3b8;
  --blue:#3b82f6;
  --blue-d:#2563eb;
  --blue-l:#dbeafe;
  --blue-xl:#eff6ff;
  --green:#10b981;
  --green-l:#d1fae5;
  --red:#ef4444;
  --red-l:#fee2e2;
  --amber:#f59e0b;
  --amber-l:#fef3c7;
  --r:10px;--r2:14px;--r3:20px;
}

[data-theme="dark"]{
  --bg:#0c0a09;
  --bg2:#1c1917;
  --white:#1c1917;
  --border:#292524;
  --border2:#44403c;
  --text:#fafaf9;
  --text2:#a8a29e;
  --text3:#78716c;
  --blue:#60a5fa;
  --blue-d:#93bbfd;
  --blue-l:#1e3a5f;
  --blue-xl:#172554;
  --green:#34d399;
  --green-l:#064e3b;
  --red:#f87171;
  --red-l:#7f1d1d;
  --amber:#fbbf24;
  --amber-l:#78350f;
}
[data-theme="dark"] .hero{
  background:linear-gradient(135deg,#1e3a5f 0%,#2d4a7c 50%,#1e3a5f 100%);
  box-shadow:0 8px 30px rgba(30,58,95,0.4);
}
[data-theme="dark"] .hero::before{background:radial-gradient(ellipse at 20% 80%,rgba(96,165,250,.1) 0%,transparent 50%)}
[data-theme="dark"] .hero::after{background:radial-gradient(ellipse at 80% 20%,rgba(56,189,248,.08) 0%,transparent 50%)}
[data-theme="dark"] body{background:#0c0a09}
[data-theme="dark"] .tag{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.15);color:rgba(255,255,255,.7)}
[data-theme="dark"] .ts-row{background:var(--white);border-color:var(--border)}
[data-theme="dark"] .ts-row .ts-title{color:var(--text)}
[data-theme="dark"] .ts-row .ts-desc{color:var(--text2)}
[data-theme="dark"] .epub-resume{background:linear-gradient(135deg,#422006,#78350f);border-color:#92400e;color:#fbbf24}
[data-theme="dark"] .epub-resume .ep-desc{color:#d97706}

html{font-size:15px;scroll-behavior:smooth}
body{
  font-family:'Poppins','Kanit',system-ui,sans-serif;
  background:linear-gradient(135deg,#E8F4FF 0%,#D8EBFF 25%,#C8E2FF 50%,#B8D9FF 75%,#A8D0FF 100%);
  background-attachment:fixed;
  color:var(--text);
  min-height:100vh;-webkit-font-smoothing:antialiased;
  -webkit-text-size-adjust:100%;
  text-rendering:optimizeLegibility;
}

@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes float{0%,100%{transform:translateY(0px)}50%{transform:translateY(-15px)}}

/* ‚ïê‚ïê‚ïê HERO ‚ïê‚ïê‚ïê */
.hero{
  background:linear-gradient(135deg,#8BB8E8 0%,#6FA8DD 50%,#5599CC 100%);
  border-bottom:none;
  padding:3rem 1.25rem 2.5rem;
  position:relative;overflow:hidden;
  box-shadow:0 8px 30px rgba(85,153,204,0.3);
  border-radius:0 0 24px 24px;
}
.hero::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at 20% 80%,rgba(255,255,255,.15) 0%,transparent 50%);
  pointer-events:none;
}
.hero::after{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at 80% 20%,rgba(255,255,255,.1) 0%,transparent 50%);
  pointer-events:none;
}
.hero-in{max-width:640px;margin:0 auto;text-align:center;position:relative;z-index:1}
.hero-title-row{
  display:inline-flex;align-items:center;gap:.7rem;justify-content:center;margin-bottom:.35rem;
}
.hero-avatar{
  width:56px;height:56px;border-radius:50%;object-fit:cover;
  border:2px solid rgba(255,255,255,0.4);background:transparent;
  filter:drop-shadow(0 4px 15px rgba(0,0,0,.15));
  flex-shrink:0;
  transition:transform .3s ease;
}
.hero-avatar:hover{
  transform:scale(1.08);
}
.hero h1{
  font-family:'Poppins','Kanit',sans-serif;
  font-size:2.2rem;font-weight:700;letter-spacing:-.02em;
  color:#fff;line-height:1.2;margin-bottom:.35rem;
  text-shadow:1px 1px 3px rgba(0,0,0,0.15);
}
.hero h1 span{color:rgba(255,255,255,.95)}
.hero-desc{font-size:.88rem;color:rgba(255,255,255,0.9);line-height:1.6;margin-bottom:1rem;font-weight:400}
.tags{display:flex;gap:.4rem;justify-content:center;flex-wrap:wrap}
.tag{
  font-size:.65rem;font-weight:600;padding:.25rem .6rem;
  border-radius:20px;background:rgba(255,255,255,.25);color:#fff;
  display:inline-flex;align-items:center;gap:.25rem;
  border:1px solid rgba(255,255,255,.35);
  box-shadow:0 2px 8px rgba(85,153,204,0.15);
  transition:all 0.2s ease;
  backdrop-filter:blur(4px);
}
.tag:hover{background:rgba(255,255,255,.4);color:#fff}

/* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
.wrap{max-width:640px;margin:0 auto;padding:1.25rem 1rem 3rem}

/* ‚ïê‚ïê‚ïê TUTORIAL ‚ïê‚ïê‚ïê */
.tut{
  background:var(--white);border:2px solid #E0E7FF;
  border-radius:var(--r3);margin-bottom:.6rem;overflow:hidden;
  box-shadow:0 4px 15px rgba(107,143,216,0.12);
  animation:slideUp 0.6s ease-out;
}
.tut:hover{box-shadow:0 8px 25px rgba(107,143,216,0.18)}
.tut-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:1rem 1.25rem;cursor:pointer;user-select:none;
}
.tut-head h3{font-family:'Poppins','Kanit',sans-serif;font-size:.88rem;font-weight:600;color:var(--text);display:flex;align-items:center;gap:.4rem}
.tut-arr{font-size:.6rem;color:var(--text3);transition:transform .2s;width:22px;height:22px;border-radius:6px;background:var(--bg);display:flex;align-items:center;justify-content:center}
.tut.open .tut-arr{transform:rotate(180deg)}
.tut-body{display:none;padding:0 1.25rem 1.25rem;font-size:.82rem;line-height:1.75;color:var(--text2)}
.tut.open .tut-body{display:block}
.tut-steps{list-style:none;counter-reset:ts}
.tut-steps li{counter-increment:ts;padding:.55rem 0 .55rem 2rem;border-bottom:1px solid var(--bg);position:relative}
.tut-steps li:last-child{border:none}
.tut-steps li::before{
  content:counter(ts);position:absolute;left:0;top:.5rem;
  width:20px;height:20px;border-radius:6px;background:var(--blue);color:white;
  font-size:.62rem;font-weight:700;display:flex;align-items:center;justify-content:center;
}
.tut-steps b{color:var(--text);font-weight:600}
.tut-steps a{color:var(--blue);text-decoration:none}
.tut-steps a:hover{text-decoration:underline}
.tut-tip{
  margin-top:.7rem;padding:.55rem .75rem;background:var(--blue-xl);
  border-radius:var(--r);font-size:.76rem;color:var(--text2);
  border:1px solid var(--blue-l);
}

/* ‚ïê‚ïê‚ïê CARD ‚ïê‚ïê‚ïê */
.card{
  background:var(--white);border:2px solid #E0E7FF;
  border-radius:var(--r3);padding:1.25rem;
  margin-bottom:.5rem;
  transition:all .2s;
  box-shadow:0 4px 15px rgba(107,143,216,0.12);
  animation:slideUp 0.6s ease-out;
}
.card:hover{box-shadow:0 8px 25px rgba(107,143,216,0.18);border-color:#c7d2fe}
.card-h{display:flex;align-items:center;gap:.5rem;margin-bottom:.85rem}
.card-n{
  width:22px;height:22px;border-radius:6px;flex-shrink:0;
  background:var(--blue);color:white;
  font-family:'Poppins',sans-serif;font-size:.65rem;font-weight:700;
  display:flex;align-items:center;justify-content:center;
}
.card-t{font-family:'Poppins','Kanit',sans-serif;font-size:.88rem;font-weight:600}

/* ‚ïê‚ïê‚ïê FORM ‚ïê‚ïê‚ïê */
.f{margin-bottom:.7rem}.f:last-child{margin-bottom:0}
.fl{display:block;font-size:.7rem;font-weight:600;color:var(--text2);margin-bottom:.25rem;letter-spacing:.02em}
.fi{
  width:100%;padding:.5rem .65rem;
  background:var(--white);border:1px solid var(--border);
  border-radius:var(--r);font-family:inherit;font-size:.84rem;
  color:var(--text);outline:none;transition:all .15s;
}
.fi:focus{border-color:var(--blue);box-shadow:0 0 0 2px rgba(59,130,246,0.08)}
.fi::placeholder{color:var(--text3)}
textarea.fi{resize:vertical;min-height:52px;line-height:1.5}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.5rem}

/* ‚ïê‚ïê‚ïê UPLOAD ‚ïê‚ïê‚ïê */
.up{
  border:1.5px dashed var(--border2);border-radius:var(--r2);
  padding:1.5rem 1rem;text-align:center;cursor:pointer;
  transition:all .2s;background:var(--white);
  box-shadow:none;
}
.up:hover,.up.drag{border-style:solid;border-color:var(--blue);background:var(--blue-xl)}
.up.ok{border-color:var(--green);border-style:solid;background:var(--green-l)}
.up .ui{font-size:1.5rem;display:block;margin-bottom:.2rem}
.up .ut{font-size:.84rem;color:var(--text2)}.up .ut b{color:var(--text);font-weight:500}
.up .uh{font-size:.68rem;color:var(--text3);margin-top:.15rem}
.up .uf{font-size:.78rem;color:var(--green);font-weight:500;margin-top:.25rem}

/* Cover */
.cov{
  width:100px;height:140px;border:1.5px dashed var(--border2);
  border-radius:var(--r);cursor:pointer;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  transition:all .2s;background:var(--white);overflow:hidden;position:relative;
  box-shadow:none;
}
.cov:hover{border-style:solid;border-color:var(--blue);background:var(--blue-xl)}
.cov.ok{border-style:solid;border-color:var(--green)}
.cov img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;z-index:1}
.cov-ph{text-align:center;font-size:.62rem;color:var(--text3)}
.cov-ph span{font-size:1.2rem;display:block;margin-bottom:.1rem}
.cov.ok .cov-ph{display:none}
.mflex{display:flex;gap:.75rem;align-items:flex-start}
.mfields{flex:1;min-width:0}

/* ‚ïê‚ïê‚ïê BUTTONS ‚ïê‚ïê‚ïê */
.brow{display:flex;gap:.4rem;margin:.6rem 0}
.btn{
  padding:.5rem .9rem;border:1px solid var(--border);border-radius:var(--r);
  font-family:inherit;font-size:.82rem;font-weight:600;letter-spacing:-.01em;
  cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:.3rem;
  box-shadow:0 1px 2px rgba(0,0,0,0.05);
}
.btn-go{
  background:var(--blue);color:white;flex:1;justify-content:center;
  border-color:transparent;
}
.btn-go:hover:not(:disabled){background:var(--blue-d);box-shadow:0 2px 8px rgba(59,130,246,0.25)}
.btn-go:disabled{opacity:.4;cursor:not-allowed}
.btn-st{background:var(--white);border:1px solid var(--border);color:var(--red)}
.btn-st:hover:not(:disabled){box-shadow:0 2px 8px rgba(239,68,68,0.15);border-color:var(--red)}
.btn-st:disabled{opacity:.3;cursor:not-allowed}
.btn-o{background:var(--white);border:1px solid var(--border);color:var(--text2);font-size:.72rem;padding:.35rem .6rem;box-shadow:0 1px 2px rgba(0,0,0,0.04)}
.btn-o:hover{box-shadow:0 2px 6px rgba(0,0,0,0.08);border-color:var(--border2)}

/* ‚ïê‚ïê‚ïê PROGRESS ‚ïê‚ïê‚ïê */
.prg{display:none;margin-bottom:.6rem}.prg.on{display:block}
.prg-box{background:var(--white);border:1px solid var(--border);border-radius:var(--r2);padding:.85rem 1rem;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
.prg-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem}
.prg-t{font-size:.78rem;color:var(--text2)}
.prg-p{font-size:.7rem;color:var(--text3);font-family:'JetBrains Mono',monospace}
.prg-track{height:14px;background:var(--bg2);border-radius:7px;overflow:hidden;border:1px solid var(--border)}
.prg-bar{height:100%;border-radius:0;width:0%;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);transition:width .3s;box-shadow:inset 0 1px 2px rgba(255,255,255,0.2)}
@keyframes pl{0%,100%{opacity:1}50%{opacity:.5}}
.prg.run .prg-t{animation:pl 1.5s infinite}

/* ‚ïê‚ïê‚ïê STATUS ‚ïê‚ïê‚ïê */
.sts{padding:.6rem .85rem;border-radius:var(--r);font-size:.78rem;display:none;margin-bottom:.6rem;border:1px solid;font-weight:600}
.sts.info{display:block;background:var(--blue-xl);border-color:var(--border);color:var(--blue-d)}
.sts.err{display:block;background:var(--red-l);border-color:var(--red);color:var(--red)}
.sts.ok{display:block;background:var(--green-l);border-color:var(--green);color:#059669}

/* ‚ïê‚ïê‚ïê RESULTS ‚ïê‚ïê‚ïê */
.res{display:none}.res.on{display:block}
.dlg{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
.dlc{
  display:flex;align-items:center;gap:.6rem;
  padding:.7rem .85rem;background:var(--white);
  border:1px solid var(--border);border-radius:var(--r2);
  cursor:pointer;transition:all .15s;text-decoration:none;color:inherit;
  box-shadow:0 1px 3px rgba(0,0,0,0.06);
}
.dlc:hover{box-shadow:0 3px 10px rgba(0,0,0,0.1);border-color:var(--border2)}
.dli{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
.dli.epub{background:var(--green-l);color:var(--green)}
.dli.txt{background:var(--amber-l);color:var(--amber)}
.dln{font-size:.8rem;font-weight:600}
.dls{font-size:.64rem;color:var(--text3);margin-top:.08rem}

/* ‚ïê‚ïê‚ïê TOC ‚ïê‚ïê‚ïê */
.toc{display:none;margin-bottom:.6rem}.toc.on{display:block}
.tocl{list-style:none}
.toci{display:flex;align-items:center;gap:.4rem;padding:.35rem .4rem;border-radius:6px;font-size:.78rem;border-bottom:1px solid var(--bg)}
.toci:hover{background:var(--bg)}
.toci .tn{font-size:.62rem;color:var(--text3);font-weight:700;min-width:24px}
.toci input{flex:1;padding:.2rem .35rem;font-size:.78rem;border:1px solid var(--border);border-radius:5px;font-family:inherit;background:var(--white);color:var(--text);outline:none}
.toci input:focus{border-color:var(--blue);box-shadow:0 0 0 2px rgba(59,130,246,0.08)}
.toci .tp{font-size:.66rem;color:var(--text3);font-family:'JetBrains Mono',monospace}
.toci .tx{cursor:pointer;color:var(--text3);font-size:.68rem;padding:.15rem .2rem;border-radius:4px;transition:all .12s}
.toci .tx:hover{color:var(--red);background:var(--red-l)}
.toca{display:flex;gap:.3rem;margin-top:.4rem}

/* ‚ïê‚ïê‚ïê COLLAPSIBLE ‚ïê‚ïê‚ïê */
.ct{display:flex;align-items:center;gap:.3rem;font-size:.7rem;color:var(--text3);cursor:pointer;padding:.3rem 0;user-select:none}
.ct:hover{color:var(--text2)}
.ct .a{transition:transform .15s;font-size:.5rem}.ct.open .a{transform:rotate(90deg)}
.cb{display:none}.cb.open{display:block}

.logb{background:var(--bg);border:1px solid var(--border);border-radius:var(--r);padding:.4rem .6rem;max-height:160px;overflow-y:auto;margin-top:.2rem;font-family:'JetBrains Mono',monospace;font-size:.62rem;line-height:1.75;color:var(--text3)}
.ll{border-bottom:1px solid var(--bg2);padding:.04rem 0}.ll:last-child{border:none}
.ll .t{color:var(--border2);margin-right:.25rem}
.ll.e{color:var(--red)}.ll.s{color:var(--green)}

.pvb{background:var(--bg);border:1px solid var(--border);border-radius:var(--r);padding:.6rem .75rem;max-height:260px;overflow-y:auto;margin-top:.2rem;font-size:.76rem;line-height:1.75;color:var(--text2);white-space:pre-wrap;word-break:break-word}

::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

.foot{text-align:center;padding:1.25rem 0;margin-top:1.25rem;font-size:.62rem;color:var(--text3);border-top:1px solid var(--border)}
.foot a{color:var(--blue);text-decoration:none}.foot a:hover{text-decoration:underline}

/* Dark Mode Toggle */
.dm-btn{
  position:fixed;top:.7rem;right:.7rem;z-index:99;width:36px;height:36px;
  border-radius:50%;border:1px solid var(--border);background:var(--white);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:1.1rem;box-shadow:0 1px 3px rgba(0,0,0,0.08);transition:all .2s;
}
.dm-btn:hover{box-shadow:0 2px 8px rgba(0,0,0,0.12);border-color:var(--border2)}

/* Lang Toggle */
.lang-btn{
  position:fixed;top:.7rem;right:3rem;z-index:99;
  padding:.3rem .6rem;border-radius:20px;border:1px solid var(--border);background:var(--white);
  cursor:pointer;font-size:.65rem;font-weight:700;color:var(--text2);
  box-shadow:0 1px 3px rgba(0,0,0,0.08);transition:all .2s;
}
.lang-btn:hover{box-shadow:0 2px 8px rgba(0,0,0,0.12);border-color:var(--border2)}

/* PDF Preview */
.pdf-pv{display:none;margin-top:.4rem;padding:.5rem;background:var(--white);border:1px solid var(--border);border-radius:var(--r2);text-align:center}
.pdf-pv.on{display:block}
.pdf-pv canvas{max-width:100%;height:auto;border-radius:var(--r);box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.pdf-pv-info{font-size:.66rem;color:var(--text3);margin-top:.3rem}

/* Cost Estimate */
.cost-bar{display:none;margin:.4rem 0;padding:.55rem .8rem;background:var(--blue-xl);border:1px solid var(--border);border-radius:var(--r);font-size:.72rem;color:var(--text2);line-height:1.5;font-weight:600}
.cost-bar.on{display:block}
.cost-bar b{color:var(--text)}

/* Nav pill */
.nav-pill{display:inline-flex;gap:.3rem;margin-top:.8rem;padding:.25rem;background:rgba(255,255,255,.3);border-radius:25px;border:1px solid rgba(255,255,255,.4);backdrop-filter:blur(4px)}
.nav-pill a{font-size:.7rem;font-weight:600;padding:.3rem .8rem;border-radius:20px;text-decoration:none;color:rgba(255,255,255,.7);transition:all .2s}
.nav-pill a.active{background:#fff;color:#5599CC;box-shadow:0 2px 8px rgba(85,153,204,0.2)}
.nav-pill a:hover:not(.active){background:rgba(255,255,255,.3);color:#fff}
[data-theme="dark"] .nav-pill{background:rgba(0,0,0,.3);border-color:rgba(255,255,255,.1)}
[data-theme="dark"] .nav-pill a.active{background:rgba(255,255,255,.15);color:#fff}

@media(max-width:640px){
  .hero h1{font-size:1.7rem}
  .hero{padding:2rem 1rem 1.5rem}
  .hero-desc{font-size:.82rem}
  .hero-avatar{width:48px;height:48px}
  .wrap{padding:1rem .75rem 2rem}
  .card{padding:1rem}
  .g2,.g3,.dlg{grid-template-columns:1fr}
  .mflex{flex-direction:column;align-items:center}
  .brow{flex-direction:column}
  .btn-go,.btn{width:100%;justify-content:center}
  .tags{gap:.3rem}.tag{font-size:.56rem;padding:.2rem .5rem}
  .nav-pill{flex-direction:column;gap:.3rem}
  .nav-pill a{font-size:.72rem;padding:.4rem .8rem}
  .tut-step{padding:.8rem}
  .tut-step .tut-num{width:28px;height:28px;font-size:.72rem}
  .tut-step .tut-t{font-size:.8rem}
  .sb-row{gap:.25rem}
  .sb-item{min-width:60px;padding:.3rem .4rem}
  .sb-val{font-size:.72rem}
  .sb-lbl{font-size:.52rem}
  .ts-row{padding:.6rem .8rem;gap:.5rem}
  .ts-title{font-size:.8rem}
  .ts-desc{font-size:.6rem}
  .dm-btn{width:36px;height:36px;font-size:1rem}
  .foot{font-size:.62rem;padding:1.5rem .75rem}
  .dlc{padding:.6rem}
}

/* Token Saver */
.ts-row{display:flex;align-items:center;gap:.75rem;margin:.6rem 0;padding:.75rem 1rem;background:var(--white);border:1px solid var(--border);border-radius:var(--r2);cursor:pointer;user-select:none;transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
.ts-row:hover{box-shadow:0 2px 8px rgba(0,0,0,0.1);border-color:var(--border2)}
.ts-row .ts-icon{font-size:1.4rem;filter:drop-shadow(0 1px 2px rgba(0,0,0,.1))}
.ts-row .ts-info{flex:1;min-width:0}
.ts-row .ts-title{font-size:.88rem;font-weight:700;color:var(--text);font-family:'Poppins','Kanit',sans-serif}
.ts-row .ts-desc{font-size:.68rem;color:var(--text2);line-height:1.4;margin-top:.1rem}
.ts-toggle{position:relative;width:36px;height:20px;border-radius:10px;background:var(--bg2);transition:all .2s;flex-shrink:0;border:1px solid var(--border)}
.ts-toggle.on{background:var(--green)}
.ts-toggle::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;background:white;transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.ts-toggle.on::after{left:17px}
.statbar{display:none;margin-bottom:.6rem}.statbar.on{display:block}
.statbar .sb-row{display:flex;gap:.4rem;flex-wrap:wrap}
.statbar .sb-item{flex:1;min-width:80px;padding:.4rem .6rem;background:var(--white);border:1px solid var(--border);border-radius:var(--r);text-align:center;box-shadow:0 1px 2px rgba(0,0,0,0.04)}
.statbar .sb-val{font-size:.82rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--text)}
.statbar .sb-lbl{font-size:.58rem;color:var(--text3);margin-top:.05rem}
.btn-res{background:var(--amber);color:white;flex:1;justify-content:center;box-shadow:0 1px 4px rgba(245,158,11,.2);display:none}
.btn-res:hover:not(:disabled){background:#d97706;box-shadow:0 2px 8px rgba(245,158,11,.25)}
.epub-resume{
  display:flex;align-items:center;gap:.5rem;padding:.6rem .9rem;
  background:linear-gradient(135deg,#fef3c7,#fde68a);border:1.5px dashed var(--amber);
  border-radius:var(--r2);cursor:pointer;margin-top:.3rem;
  font-size:.76rem;color:#92400e;transition:all .2s;
}
.epub-resume:hover{background:linear-gradient(135deg,#fde68a,#fcd34d);border-color:#d97706;transform:translateY(-1px)}
.epub-resume .ep-icon{font-size:1.3rem}
.epub-resume .ep-info{flex:1}
.epub-resume .ep-title{font-weight:600;font-size:.78rem}
.epub-resume .ep-desc{font-size:.66rem;color:#a16207;margin-top:.1rem}

/* ‚ïê‚ïê‚ïê Edit Modal ‚ïê‚ïê‚ïê */
.edt-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center}
.edt-overlay.on{display:flex}
.edt-box{background:var(--white);border-radius:var(--r3);padding:1.25rem;width:92%;max-width:600px;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 8px 30px rgba(0,0,0,0.12);border:1px solid var(--border)}
.edt-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem}
.edt-head h3{font-size:.88rem;font-weight:600;font-family:'Poppins','Kanit',sans-serif}
.edt-close{width:28px;height:28px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.8rem;color:var(--text3)}
.edt-close:hover{color:var(--red);border-color:var(--red)}
.edt-ta{flex:1;width:100%;padding:.6rem;border:1.5px solid var(--border);border-radius:var(--r);font-family:'Kanit',sans-serif;font-size:.82rem;line-height:1.8;color:var(--text);background:var(--bg);resize:none;outline:none;min-height:200px}
.edt-ta:focus{border-color:var(--blue)}
.edt-foot{display:flex;gap:.3rem;margin-top:.5rem;justify-content:flex-end}
.edt-nav{display:flex;align-items:center;gap:.4rem;margin-bottom:.4rem;justify-content:center}
.edt-nav button{padding:.25rem .6rem;border:1px solid var(--border);background:var(--white);border-radius:var(--r);cursor:pointer;font-size:.7rem;color:var(--text2);transition:all .15s}
.edt-nav button:hover{border-color:var(--blue);background:var(--blue-xl)}
.edt-nav span{font-size:.68rem;color:var(--text3)}
/* ‚ïê‚ïê‚ïê Usage Stats ‚ïê‚ïê‚ïê */
.ustats{font-size:.6rem;color:var(--text3);text-align:center;margin-top:.3rem;padding:.3rem;background:var(--bg);border-radius:var(--r);border:1px solid var(--border)}
</style>
</head>
<body>

<button class="dm-btn" id="dmBtn" title="Dark/Light Mode">üåô</button>
<button class="lang-btn" id="langBtn" title="Switch Language">EN</button>

<header class="hero">
  <div class="hero-in">
    <div class="hero-title-row">
      <img src="rainflow.png" alt="rainflowData" class="hero-avatar">
      <h1>üê± Catto<span>EPUB</span> üìò</h1>
    </div>
    <p class="hero-desc">PDF to EPUB Converter (Thai)<br>‡πÅ‡∏õ‡∏•‡∏á PDF ‡πÄ‡∏õ‡πá‡∏ô EPUB ‡∏î‡πâ‡∏ß‡∏¢ Typhoon OCR ‚Äî ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</p>
    <div class="tags">
      <span class="tag">üáπüá≠ Thai OCR</span>
      <span class="tag">üì± Mobile Ready</span>
      <span class="tag">üîí ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</span>
      <span class="tag">‚ö° Client-Side</span>
    </div>
    <div class="nav-pill">
      <a href="index.html" class="active">üê± CattoEPUB</a>
      <a href="translate.html">üê± CattoTranslate</a>
    </div>
    <p style="font-size:.78rem;color:rgba(255,255,255,0.9);margin-top:.75rem;line-height:1.6">üí° Based on <strong style="color:#fff">Bepub</strong> by <a href="https://www.facebook.com/groups/ebookreader/posts/25556985560668239" target="_blank" style="color:#fff;text-decoration:underline;text-underline-offset:2px">Ken Takahashi</a> (<a href="https://colab.research.google.com/drive/1lgmYkuEeSUlVDLpplXCnFIQdJP9YMWjw?usp=sharing" target="_blank" style="color:#fff;text-decoration:underline;text-underline-offset:2px">Colab</a>)<br>Web version by <strong style="color:#fff">cattoData</strong></p>
  </div>
</header>

<div class="wrap">

  <!-- Tutorial -->
  <div class="tut open" id="tut">
    <div class="tut-head" id="tut-tog">
      <h3>üìñ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
      <div class="tut-arr">‚ñº</div>
    </div>
    <div class="tut-body">
      <ol class="tut-steps">
        <li><b>‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Typhoon API Key</b> ‚Äî ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <a href="https://opentyphoon.ai" target="_blank">opentyphoon.ai</a> ‡∏Å‡∏î Sign Up ‚Üí ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î‡∏ó‡∏µ‡πà <b>Profile (avatar ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô)</b> ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>API Keys</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á key</li>
        <li><b>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF</b> ‚Äî ‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö PDF ‡∏†‡∏≤‡∏û‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ</li>
        <li><b>‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</b> ‚Äî Title, Author, Publisher, ‡∏õ‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</li>
        <li><b>‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå"</b> ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö OCR ‡∏ó‡∏µ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á EPUB ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
        <li><b>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç</b> ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ö‡∏ó/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà</li>
        <li><b>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</b> ‚Äî ‡πÑ‡∏î‡πâ EPUB + TXT ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏ö‡∏ô e-reader</li>
      </ol>
    </div>
  </div>

  <!-- Step 1 -->
  <div class="card">
    <div class="card-h"><div class="card-n">1</div><div class="card-t">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF</div></div>
    <div class="up" id="dz">
      <span class="ui">üìÑ</span>
      <div class="ut"><b>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</b> ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡∏°‡∏≤‡∏ß‡∏≤‡∏á</div>
      <div class="uh">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .pdf ‚Äî ‡πÑ‡∏ü‡∏•‡πå‡∏™‡πÅ‡∏Å‡∏ô‡∏Å‡πá‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</div>
      <div class="uf" id="fn"></div>
    </div>
    <input type="file" id="fi" accept=".pdf" hidden>
    <div class="pdf-pv" id="pdfPv"><canvas id="pdfPvC"></canvas><div class="pdf-pv-info" id="pdfPvI"></div></div>
    <div class="epub-resume" id="epubResume" title="‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î EPUB ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á">
      <span class="ep-icon">üìï</span>
      <div class="ep-info">
        <div class="ep-title">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î EPUB ‡πÄ‡∏î‡∏¥‡∏° ‚Äî ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á</div>
        <div class="ep-desc">‡∏°‡∏µ EPUB ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ? ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß resume ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏õ‡∏•‡∏á</div>
      </div>
    </div>
    <input type="file" id="epubFi" accept=".epub" hidden>
  </div>

  <!-- Token Saver -->
  <div class="ts-row" id="tsrow" title="Token Saver Mode">
    <span class="ts-icon">üíé</span>
    <div class="ts-info">
      <div class="ts-title">Token Saver Mode</div>
      <div class="ts-desc">‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î token ~85% ‚Äî ‡∏î‡∏∂‡∏á text ‡∏Å‡πà‡∏≠‡∏ô, ‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á, JPEG, ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î, prompt ‡∏™‡∏±‡πâ‡∏ô</div>
    </div>
    <div class="ts-toggle" id="tstog"></div>
  </div>
  <input type="checkbox" id="tscb" hidden>

  <div class="ts-row" id="imgrow" title="‡∏ù‡∏±‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô EPUB" style="border-color:var(--border2);background:var(--white)">
    <span class="ts-icon">üñºÔ∏è</span>
    <div class="ts-info">
      <div class="ts-title">‡∏£‡∏ß‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤</div>
      <div class="ts-desc">‡∏ù‡∏±‡∏á‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÉ‡∏ô EPUB ‚Äî ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ PDF ‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡∏ù‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô)</div>
    </div>
    <div class="ts-toggle" id="imgtog"></div>
  </div>
  <input type="checkbox" id="imgcb" hidden>

  <!-- Step 2 -->
  <div class="card">
    <div class="card-h"><div class="card-n">2</div><div class="card-t">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div></div>
    <div class="g2" style="margin-bottom:.5rem">
      <div class="f"><label class="fl">OCR Provider</label><select class="fi" id="prov" style="cursor:pointer"><option value="typhoon">üáπüá≠ Typhoon OCR (Thai ‡πÄ‡∏Å‡πà‡∏á)</option><option value="gemini">‚ú® Gemini Flash (‡∏ü‡∏£‡∏µ 15 RPM)</option></select></div>
      <div class="f"><label class="fl" id="ak-lbl">Typhoon API Key</label><input type="password" class="fi" id="ak" placeholder="typhoon-xxxxxxxx" autocomplete="off"></div>
    </div>
    <div class="g3">
      <div class="f"><label class="fl">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤</label><input type="number" class="fi" id="sp" value="1" min="1"></div>
      <div class="f"><label class="fl">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏´‡∏ô‡πâ‡∏≤</label><input type="number" class="fi" id="ep" value="0" min="0" placeholder="0=‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"></div>
      <div class="f"><label class="fl">‡∏•‡∏ö‡∏Ñ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞</label><input type="text" class="fi" id="cr" placeholder="‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,"></div>
    </div>
  </div>

  <!-- Step 3 -->
  <div class="card">
    <div class="card-h"><div class="card-n">3</div><div class="card-t">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</div></div>
    <div class="mflex">
      <div class="cov" id="cz"><div class="cov-ph"><span>üñºÔ∏è</span>Cover</div></div>
      <input type="file" id="ci" accept="image/*" hidden>
      <div class="mfields">
        <div class="g2">
          <div class="f"><label class="fl">Title</label><input type="text" class="fi" id="mt" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠"></div>
          <div class="f"><label class="fl">Author</label><input type="text" class="fi" id="ma" placeholder="‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á"></div>
        </div>
        <div class="g2">
          <div class="f"><label class="fl">Publisher</label><input type="text" class="fi" id="mp" placeholder="‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå"></div>
          <div class="f"><label class="fl">Language</label><input type="text" class="fi" id="ml" value="th"></div>
        </div>
        <div class="f"><label class="fl">Description</label><textarea class="fi" id="md" rows="2" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)"></textarea></div>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="cost-bar" id="costBar"></div>
  <div class="brow">
    <button class="btn btn-go" id="bgo" disabled>‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå</button>
    <button class="btn btn-res" id="bres" disabled>‚ñ∂ ‡∏ï‡πà‡∏≠</button>
    <button class="btn btn-st" id="bst" disabled>‚ñ† ‡∏´‡∏¢‡∏∏‡∏î</button>
  </div>
  <div id="recoverBox" style="display:none;margin-bottom:.6rem">
    <div style="padding:.7rem 1rem;background:var(--amber-l);border:1.5px solid var(--amber);border-radius:var(--r2);font-size:.76rem;color:#92400e">
      <div style="font-weight:600;margin-bottom:.3rem">üíæ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ PDF ‡∏Å‡πá‡∏™‡∏£‡πâ‡∏≤‡∏á EPUB ‡πÑ‡∏î‡πâ!</div>
      <div id="recoverInfo" style="font-size:.68rem;color:#a16207;margin-bottom:.4rem"></div>
      <div style="display:flex;gap:.3rem">
        <button class="btn btn-go" id="bRecover" style="flex:none;padding:.4rem .8rem;font-size:.72rem;background:var(--amber);box-shadow:none">üì• ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á EPUB</button>
        <button class="btn btn-o" id="bRecoverClear" style="font-size:.68rem;padding:.35rem .6rem">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á</button>
      </div>
    </div>
  </div>

  <!-- Stats Bar -->
  <div class="statbar" id="statbar">
    <div class="sb-row">
      <div class="sb-item"><div class="sb-val" id="sv-total">0</div><div class="sb-lbl">üìÑ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
      <div class="sb-item"><div class="sb-val" id="sv-text">0</div><div class="sb-lbl">üíé Text</div></div>
      <div class="sb-item"><div class="sb-val" id="sv-ocr">0</div><div class="sb-lbl">üîç OCR</div></div>
      <div class="sb-item"><div class="sb-val" id="sv-skip">0</div><div class="sb-lbl">‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°</div></div>
    </div>
    <div class="sb-row" style="margin-top:.3rem">
      <div class="sb-item"><div class="sb-val" id="sv-tokin">0</div><div class="sb-lbl">üì® Tokens In</div></div>
      <div class="sb-item"><div class="sb-val" id="sv-tokout">0</div><div class="sb-lbl">üìù Tokens Out</div></div>
      <div class="sb-item"><div class="sb-val" id="sv-toktotal">0</div><div class="sb-lbl">üéØ Total Tokens</div></div>
    </div>
  </div>

  <div class="prg" id="prg">
    <div class="prg-box">
      <div class="prg-top"><span class="prg-t" id="pt">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</span><span class="prg-p" id="pp">0%</span></div>
      <div class="prg-track"><div class="prg-bar" id="pb"></div></div>
      <div style="text-align:center;margin-top:.3rem;font-size:.68rem;color:var(--text3)" id="pm"></div>
    </div>
  </div>

  <div class="sts" id="sts"></div>

  <div class="res" id="res">
    <div class="card">
      <div class="card-h"><div class="card-n" style="background:var(--green)">‚úì</div><div class="card-t">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</div></div>
      <div class="dlg">
        <a class="dlc" id="de" href="#" download><div class="dli epub">üìï</div><div><div class="dln">EPUB</div><div class="dls" id="es">‚Äî</div></div></a>
        <a class="dlc" id="dt" href="#" download><div class="dli txt">üìù</div><div><div class="dln">TXT</div><div class="dls" id="ts">‚Äî</div></div></a>
      </div>
    </div>
  </div>

  <div class="toc" id="tocsec">
    <div class="card">
      <div class="card-h"><div class="card-n" style="background:var(--amber)">üìë</div><div class="card-t">‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç</div></div>
      <p style="font-size:.7rem;color:var(--text3);margin-bottom:.4rem">‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏à‡∏≤‡∏Å OCR ‚Äî ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏•‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ</p>
      <ul class="tocl" id="tocl"></ul>
      <div class="toca"><button class="btn btn-o" id="bac">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó</button><button class="btn btn-o" id="brb">üîÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á EPUB ‡πÉ‡∏´‡∏°‡πà</button></div>
    </div>
  </div>

  <div id="pvsec" style="display:none;margin-top:.3rem">
    <div class="ct" id="pvt"><span class="a">‚ñ∂</span> ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
    <div class="cb pvb" id="pvb"></div>
  </div>

  <!-- Edit OCR Results -->
  <div id="editBtn" style="display:none;margin-top:.3rem">
    <button class="btn btn-o" id="bEdit" style="width:100%;justify-content:center;gap:.3rem">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° OCR ‡∏ó‡∏µ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤</button>
  </div>

  <div style="margin-top:.3rem">
    <div class="ct" id="lt"><span class="a">‚ñ∂</span> Console Log</div>
    <div class="cb logb" id="lb"></div>
  </div>

  <!-- Usage Stats -->
  <div class="ustats" id="ustats"></div>

  <!-- Edit Modal -->
  <div class="edt-overlay" id="edtOverlay">
    <div class="edt-box">
      <div class="edt-head"><h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡πâ‡∏≤ <span id="edtPageNum"></span></h3><button class="edt-close" id="edtClose">‚úï</button></div>
      <div class="edt-nav">
        <button id="edtPrev">‚óÄ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
        <span id="edtPageInfo">1 / 1</span>
        <button id="edtNext">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂</button>
      </div>
      <textarea class="edt-ta" id="edtTa"></textarea>
      <div class="edt-foot">
        <button class="btn btn-o" id="edtCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn btn-go" id="edtSave" style="flex:none;padding:.4rem 1rem">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <div class="foot">
    <strong>Original concept:</strong> Bepub by Ken Takahashi (<a href="https://colab.research.google.com/drive/1lgmYkuEeSUlVDLpplXCnFIQdJP9YMWjw?usp=sharing" target="_blank" style="color:var(--text3);text-decoration:none;font-size:.58rem">Colab</a>) ¬∑ <strong>Web version:</strong> cattoData<br>
    Built with <a href="https://opentyphoon.ai" target="_blank">Typhoon OCR</a> ¬∑ <a href="https://mozilla.github.io/pdf.js/" target="_blank">PDF.js</a> ¬∑ <a href="https://stuk.github.io/jszip/" target="_blank">JSZip</a><br>
    <span style="font-size:.58rem;color:var(--text3)">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå ¬∑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Typhoon API ¬∑ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏î‡πÜ<br>Shared in <a href="https://www.facebook.com/groups/778412228952249/" target="_blank" style="color:var(--text3);text-decoration:none">‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ô‡∏±‡∏Å‡∏≠‡πà‡∏≤‡∏ô eBook</a></span>
    <div style="margin-top:.6rem;display:flex;align-items:center;justify-content:center;gap:.5rem;flex-wrap:wrap">
      <a href="https://github.com/RainflowData/PDF-EPUB-Converter-Thai" target="_blank" style="display:inline-flex;align-items:center;gap:.3rem;padding:.3rem .7rem;background:var(--bg);border:1px solid var(--border);border-radius:100px;text-decoration:none;color:var(--text2);font-size:.64rem;font-weight:600;transition:all .15s" onmouseover="this.style.borderColor='var(--purple)';this.style.color='var(--purple)'" onmouseout="this.style.borderColor='';this.style.color=''">
        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
        GitHub
      </a>
      <img src="https://api.visitorbadge.io/api/visitors?path=https%3A%2F%2Frainflowdata.github.io%2FPDF-EPUB-Converter-Thai&label=visitors&countColor=%238b5cf6&labelColor=%236d28d9&style=flat-square" alt="visitors" style="height:20px">
    </div>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
let pdfFile,pdfDoc,isCancelled=false,isProc=false,coverUrl,coverMime,ocrS=[],chaps=[],pageImgs=[];
var stats={total:0,textExtract:0,ocrApi:0,skipped:0},tokenUsage={prompt:0,completion:0,total:0},lastStopPage=0;
const $=id=>document.getElementById(id);

/* ‚ïê‚ïê‚ïê i18n ‚ïê‚ïê‚ïê */
var _lang=localStorage.getItem('bepub_lang')||'th';
var T={
  th:{
    heroDesc:'PDF to EPUB Converter (Thai)<br>‡πÅ‡∏õ‡∏•‡∏á PDF ‡πÄ‡∏õ‡πá‡∏ô EPUB ‡∏î‡πâ‡∏ß‡∏¢ Typhoon OCR ‚Äî ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á',
    howTo:'üìñ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',uploadPdf:'‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF',
    clickOrDrag:'<b>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</b> ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡∏°‡∏≤‡∏ß‡∏≤‡∏á',pdfHint:'‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .pdf ‚Äî ‡πÑ‡∏ü‡∏•‡πå‡∏™‡πÅ‡∏Å‡∏ô‡∏Å‡πá‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ',
    epubResTitle:'‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î EPUB ‡πÄ‡∏î‡∏¥‡∏° ‚Äî ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á',epubResDesc:'‡∏°‡∏µ EPUB ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ? ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß resume ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏õ‡∏•‡∏á',
    tsSaver:'Token Saver Mode',tsDesc:'‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î token ~85% ‚Äî ‡∏î‡∏∂‡∏á text ‡∏Å‡πà‡∏≠‡∏ô, ‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á, JPEG, ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î, prompt ‡∏™‡∏±‡πâ‡∏ô',
    imgEmbed:'‡∏£‡∏ß‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤',imgDesc:'‡∏ù‡∏±‡∏á‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÉ‡∏ô EPUB ‚Äî ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ PDF ‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡∏ù‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô)',
    settings:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤',startPage:'‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤',endPage:'‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏´‡∏ô‡πâ‡∏≤',removeWords:'‡∏•‡∏ö‡∏Ñ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞',
    bookInfo:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠',startBtn:'‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå',stopBtn:'‚ñ† ‡∏´‡∏¢‡∏∏‡∏î',
    download:'‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î',toc:'‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç',addChapter:'+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó',rebuildEpub:'üîÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á EPUB ‡πÉ‡∏´‡∏°‡πà',
    previewText:'‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°',consoleLog:'Console Log',
    costEst:'üí∞ ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢',processing:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...',
    /* NEW extended translations */
    tutStep1:'<b>‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Typhoon API Key</b> ‚Äî ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <a href="https://opentyphoon.ai" target="_blank">opentyphoon.ai</a> ‡∏Å‡∏î Sign Up ‚Üí ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î‡∏ó‡∏µ‡πà <b>Profile (avatar ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô)</b> ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>API Keys</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á key',
    tutStep2:'<b>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF</b> ‚Äî ‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö PDF ‡∏†‡∏≤‡∏û‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ',
    tutStep3:'<b>‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</b> ‚Äî Title, Author, Publisher, ‡∏õ‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)',
    tutStep4:'<b>‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå"</b> ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö OCR ‡∏ó‡∏µ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á EPUB ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
    tutStep5:'<b>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç</b> ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ö‡∏ó/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà',
    tutStep6:'<b>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</b> ‚Äî ‡πÑ‡∏î‡πâ EPUB + TXT ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏ö‡∏ô e-reader',
    provLabel:'OCR Provider',akLabel:'Typhoon API Key',
    spLabel:'‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤',epLabel:'‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏´‡∏ô‡πâ‡∏≤',crLabel:'‡∏•‡∏ö‡∏Ñ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞',crPlaceholder:'‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,',
    titlePh:'‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠',authorPh:'‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á',pubPh:'‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå',descPh:'‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)',
    sbTotal:'üìÑ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',sbText:'üíé Text',sbOcr:'üîç OCR',sbSkip:'‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°',
    continueBtn:'‚ñ∂ ‡∏ï‡πà‡∏≠',
    recoverTitle:'üíæ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ PDF ‡∏Å‡πá‡∏™‡∏£‡πâ‡∏≤‡∏á EPUB ‡πÑ‡∏î‡πâ!',
    recoverBtn:'üì• ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á EPUB',recoverClear:'üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á',
    tagOcr:'üáπüá≠ Thai OCR',tagMobile:'üì± Mobile Ready',tagPrivacy:'üîí ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå',tagClient:'‚ö° Client-Side',
    epEndPh:'0=‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'
  },
  en:{
    heroDesc:'PDF to EPUB Converter (Thai)<br>Convert PDF to EPUB with Typhoon OCR ‚Äî works in browser, no install needed',
    howTo:'üìñ How to Use',uploadPdf:'Upload PDF',
    clickOrDrag:'<b>Click to select</b> or drag & drop',pdfHint:'Supports .pdf ‚Äî scanned files work too',
    epubResTitle:'Upload existing EPUB ‚Äî Resume',epubResDesc:'Have a partial EPUB? Upload it to resume from where you left off',
    tsSaver:'Token Saver Mode',tsDesc:'Save ~85% tokens ‚Äî extract text first, skip blanks, JPEG, smaller images, shorter prompt',
    imgEmbed:'Include Page Images',imgDesc:'Embed illustrations in EPUB ‚Äî for digital PDFs with real images only (skips scanned pages)',
    settings:'Settings',startPage:'Start Page',endPage:'End Page',removeWords:'Remove Words',
    bookInfo:'Book Information',startBtn:'‚ñ∂ Start Conversion',stopBtn:'‚ñ† Stop',
    download:'Download',toc:'Table of Contents',addChapter:'+ Add Chapter',rebuildEpub:'üîÑ Rebuild EPUB',
    previewText:'Preview Text',consoleLog:'Console Log',
    costEst:'üí∞ Cost Estimate',processing:'Processing...',
    /* NEW extended translations */
    tutStep1:'<b>Get Typhoon API Key</b> ‚Äî Go to <a href="https://opentyphoon.ai" target="_blank">opentyphoon.ai</a> ‚Üí Sign Up ‚Üí Click <b>Profile (top-right avatar)</b> ‚Üí <b>API Keys</b> to create key',
    tutStep2:'<b>Upload PDF</b> ‚Äî Drag & drop or click to select. Scanned PDFs supported',
    tutStep3:'<b>Enter book info</b> ‚Äî Title, Author, Publisher, cover image (optional)',
    tutStep4:'<b>Click "Start Conversion"</b> ‚Äî OCR runs page by page and creates EPUB automatically',
    tutStep5:'<b>Edit Table of Contents</b> ‚Äî Auto-detected chapters/headings can be edited, then rebuild',
    tutStep6:'<b>Download</b> ‚Äî Get EPUB + TXT ready for your e-reader',
    provLabel:'OCR Provider',akLabel:'Typhoon API Key',
    spLabel:'Start Page',epLabel:'End Page',crLabel:'Remove Words',crPlaceholder:'Separate with ,',
    titlePh:'Book title',authorPh:'Author',pubPh:'Publisher',descPh:'Description (optional)',
    sbTotal:'üìÑ Total',sbText:'üíé Text',sbOcr:'üîç OCR',sbSkip:'‚è≠Ô∏è Skip',
    continueBtn:'‚ñ∂ Continue',
    recoverTitle:'üíæ Recovery data found ‚Äî Build EPUB without PDF!',
    recoverBtn:'üì• Recover ‚Üí Build EPUB',recoverClear:'üóëÔ∏è Delete',
    tagOcr:'üáπüá≠ Thai OCR',tagMobile:'üì± Mobile Ready',tagPrivacy:'üîí Data never leaves browser',tagClient:'‚ö° Client-Side',
    epEndPh:'0=All'
  }
};
function applyLang(){
  var t=T[_lang];
  document.querySelector('.hero-desc').innerHTML=t.heroDesc;
  document.querySelector('#tut-tog h3').textContent=t.howTo;
  var cards=document.querySelectorAll('.card-t');
  if(cards[0])cards[0].textContent=t.uploadPdf;
  if(cards[1])cards[1].textContent=t.settings;
  if(cards[2])cards[2].textContent=t.bookInfo;
  document.querySelector('.ut').innerHTML=t.clickOrDrag;
  document.querySelector('.uh').textContent=t.pdfHint;
  document.querySelector('.ep-title').textContent=t.epubResTitle;
  document.querySelector('.ep-desc').textContent=t.epubResDesc;
  document.querySelector('#tsrow .ts-title').textContent=t.tsSaver;
  document.querySelector('#tsrow .ts-desc').textContent=t.tsDesc;
  document.querySelector('#imgrow .ts-title').textContent=t.imgEmbed;
  document.querySelector('#imgrow .ts-desc').textContent=t.imgDesc;
  $('bgo').textContent=t.startBtn;$('bst').textContent=t.stopBtn;
  $('bac').textContent=t.addChapter;$('brb').textContent=t.rebuildEpub;
  var dlCard=document.querySelector('#res .card-t');if(dlCard)dlCard.textContent=t.download;
  var tocCard=document.querySelector('#tocsec .card-t');if(tocCard)tocCard.textContent=t.toc;
  /* Extended translations */
  var tutSteps=document.querySelectorAll('.tut-steps li');
  if(tutSteps[0])tutSteps[0].innerHTML=t.tutStep1;
  if(tutSteps[1])tutSteps[1].innerHTML=t.tutStep2;
  if(tutSteps[2])tutSteps[2].innerHTML=t.tutStep3;
  if(tutSteps[3])tutSteps[3].innerHTML=t.tutStep4;
  if(tutSteps[4])tutSteps[4].innerHTML=t.tutStep5;
  if(tutSteps[5])tutSteps[5].innerHTML=t.tutStep6;
  var labels=document.querySelectorAll('.fl');
  labels.forEach(function(l){
    if(l.id==='ak-lbl')return;
    if(l.textContent.match(/‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤|Start Page/))l.textContent=t.spLabel;
    if(l.textContent.match(/‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏´‡∏ô‡πâ‡∏≤|End Page/))l.textContent=t.epLabel;
    if(l.textContent.match(/‡∏•‡∏ö‡∏Ñ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞|Remove Words/))l.textContent=t.crLabel;
    if(l.textContent.match(/OCR Provider/))l.textContent=t.provLabel;
  });
  $('sp').previousElementSibling&&($('cr').placeholder=t.crPlaceholder);
  $('mt').placeholder=t.titlePh;$('ma').placeholder=t.authorPh;
  $('mp').placeholder=t.pubPh;$('md').placeholder=t.descPh;
  $('ep').placeholder=t.epEndPh;
  var tags=document.querySelectorAll('.tag');
  if(tags[0])tags[0].textContent=t.tagOcr;
  if(tags[1])tags[1].textContent=t.tagMobile;
  if(tags[2])tags[2].textContent=t.tagPrivacy;
  if(tags[3])tags[3].textContent=t.tagClient;
  var sbLabels=document.querySelectorAll('.sb-lbl');
  if(sbLabels[0])sbLabels[0].textContent=t.sbTotal;
  if(sbLabels[1])sbLabels[1].textContent=t.sbText;
  if(sbLabels[2])sbLabels[2].textContent=t.sbOcr;
  if(sbLabels[3])sbLabels[3].textContent=t.sbSkip;
  $('pt').textContent=t.processing;
  $('langBtn').textContent=_lang==='th'?'EN':'TH';
}

/* ‚ïê‚ïê‚ïê Dark Mode ‚ïê‚ïê‚ïê */
var _dark=localStorage.getItem('bepub_dark')==='1';
function applyDark(){
  document.documentElement.setAttribute('data-theme',_dark?'dark':'');
  $('dmBtn').textContent=_dark?'‚òÄÔ∏è':'üåô';
  localStorage.setItem('bepub_dark',_dark?'1':'0');
}
$('dmBtn').onclick=function(){_dark=!_dark;applyDark()};
applyDark();

/* ‚ïê‚ïê‚ïê Language Toggle ‚ïê‚ïê‚ïê */
$('langBtn').onclick=function(){_lang=_lang==='th'?'en':'th';localStorage.setItem('bepub_lang',_lang);applyLang()};

/* ‚ïê‚ïê‚ïê Remember API Key ‚ïê‚ïê‚ïê */
var savedKey=localStorage.getItem('bepub_apikey')||'';
var savedProv=localStorage.getItem('bepub_prov')||'typhoon';
if(savedKey){$('ak').value=savedKey}
if(savedProv){$('prov').value=savedProv;if(savedProv==='gemini'){$('ak-lbl').textContent='Gemini API Key';$('ak').placeholder='AIzaSy...'}}
applyLang();

/* ‚ïê‚ïê‚ïê Cost Estimate ‚ïê‚ïê‚ïê */
function updateCost(){
  if(!pdfDoc){$('costBar').style.display='none';return}
  var pages=pdfDoc.numPages,ts=$('tscb').checked,prov=$('prov').value;
  var s0=Math.max(1,+$('sp').value||1),e0=+$('ep').value||0;
  var end=(e0===0||e0>pages)?pages:e0;
  var numPages=end-s0+1;if(numPages<1)numPages=pages;
  var tokPerPage=ts?1500:4000,totalTok=numPages*tokPerPage;
  var cost;
  if(prov==='gemini'){cost='‡∏ü‡∏£‡∏µ (Gemini Flash free tier)'}
  else{var usd=(totalTok/1000*0.003).toFixed(2);cost='~$'+usd+' USD (~'+Math.round(totalTok/1000)+'K tokens)'}
  $('costBar').innerHTML='üí∞ '+(_lang==='en'?'Estimate':'‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì')+': <b>'+cost+'</b> ¬∑ '+numPages+' '+(_lang==='en'?'pages':'‡∏´‡∏ô‡πâ‡∏≤')+(ts?' (Token Saver)':'');
  $('costBar').style.display='block';
}

/* ‚ïê‚ïê‚ïê PDF Preview Thumbnail ‚ïê‚ïê‚ïê */
async function showPdfPreview(){
  if(!pdfDoc)return;
  try{
    var pg1=await pdfDoc.getPage(1),vp1=pg1.getViewport({scale:1});
    var sc=180/Math.max(vp1.width,vp1.height),vp2=pg1.getViewport({scale:sc});
    var pvC=$('pdfPvC');pvC.width=vp2.width;pvC.height=vp2.height;
    await pg1.render({canvasContext:pvC.getContext('2d'),viewport:vp2}).promise;
    $('pdfPvI').textContent=pdfDoc.numPages+' '+(_lang==='en'?'pages':'‡∏´‡∏ô‡πâ‡∏≤');
    $('pdfPv').style.display='flex';
  }catch(e){}
}

/* ‚ïê‚ïê‚ïê Notification helper ‚ïê‚ïê‚ïê */
function sendNotif(title,body){
  if(!('Notification' in window))return;
  if(Notification.permission==='granted'){new Notification(title,{body:body,icon:'rainflow.png'})}
  else if(Notification.permission!=='denied'){Notification.requestPermission().then(function(p){if(p==='granted')new Notification(title,{body:body,icon:'rainflow.png'})})}
}

$('tut-tog').onclick=()=>$('tut').classList.toggle('open');
document.querySelectorAll('.ct').forEach(e=>e.onclick=function(){this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')});

function log(m,t=''){const d=document.createElement('div');d.className='ll '+(t==='error'?'e':t==='success'?'s':'');d.innerHTML=`<span class="t">${new Date().toLocaleTimeString('th',{hour12:0})}</span>${m}`;$('lb').appendChild(d);$('lb').scrollTop=9e9}
function setSt(m,t){$('sts').className='sts '+t;$('sts').textContent=m}
function updateStats(){$('sv-total').textContent=stats.total;$('sv-text').textContent=stats.textExtract;$('sv-ocr').textContent=stats.ocrApi;$('sv-skip').textContent=stats.skipped;$('sv-tokin').textContent=tokenUsage.prompt.toLocaleString();$('sv-tokout').textContent=tokenUsage.completion.toLocaleString();$('sv-toktotal').textContent=tokenUsage.total.toLocaleString()}

/* === localStorage Save/Restore === */
var LS_KEY='bepub_progress';
function saveProgress(fileName){
  try{localStorage.setItem(LS_KEY,JSON.stringify({v:2,fileName:fileName,ocrS:ocrS,stats:stats,tokenUsage:tokenUsage,lastStopPage:lastStopPage,chaps:chaps,ts:Date.now()}))}catch(e){}
}
function loadProgress(){
  try{var d=localStorage.getItem(LS_KEY);return d?JSON.parse(d):null}catch(e){return null}
}
function clearProgress(){try{localStorage.removeItem(LS_KEY)}catch(e){}}

/* === EPUB Resume Upload === */
$('epubResume').onclick=function(){$('epubFi').click()};
/* Drag & Drop EPUB */
$('epubResume').ondragover=function(e){e.preventDefault();this.style.borderColor='var(--a)';this.style.opacity='1'};
$('epubResume').ondragleave=function(){this.style.borderColor='';this.style.opacity=''};
$('epubResume').ondrop=function(e){
  e.preventDefault();this.style.borderColor='';this.style.opacity='';
  var f=e.dataTransfer.files[0];
  if(f&&f.name.toLowerCase().endsWith('.epub')){
    var dt=new DataTransfer();dt.items.add(f);$('epubFi').files=dt.files;
    $('epubFi').dispatchEvent(new Event('change'));
  }
};
$('epubFi').onchange=async function(ev){
  var file=ev.target.files[0];if(!file)return;
  try{
    setSt('üìï ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô EPUB...','info');
    log('üìï ‡∏≠‡πà‡∏≤‡∏ô EPUB: '+file.name);
    var buf=await file.arrayBuffer();
    var zip=await JSZip.loadAsync(buf);
    /* ‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå p0.xhtml, p1.xhtml, ... ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç */
    var pages=[];
    zip.forEach(function(path,entry){
      var m=path.match(/p(\d+)\.xhtml$/);
      if(m)pages.push({idx:+m[1],path:path});
    });
    pages.sort(function(a,b){return a.idx-b.idx});
    if(!pages.length){setSt('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô EPUB ‚Äî ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà EPUB ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å CattoEPUB','err');log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö p*.xhtml ‡πÉ‡∏ô EPUB','error');return}
    /* ‡∏≠‡πà‡∏≤‡∏ô text ‡∏à‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤ */
    var restored=[];
    var maxIdx=pages[pages.length-1].idx;
    for(var i=0;i<=maxIdx;i++)restored.push('');
    for(var pi=0;pi<pages.length;pi++){
      var xhtml=await zip.file(pages[pi].path).async('string');
      /* ‡∏î‡∏∂‡∏á text ‡∏à‡∏≤‡∏Å <body>...</body> */
      var bodyM=xhtml.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
      if(bodyM){
        var html=bodyM[1];
        /* ‡πÅ‡∏õ‡∏•‡∏á HTML ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô markdown-like text */
        var txt=html
          .replace(/<h1[^>]*>(.*?)<\/h1>/gi,'# $1\n')
          .replace(/<h2[^>]*>(.*?)<\/h2>/gi,'## $1\n')
          .replace(/<h3[^>]*>(.*?)<\/h3>/gi,'### $1\n')
          .replace(/<strong>(.*?)<\/strong>/gi,'**$1**')
          .replace(/<em>(.*?)<\/em>/gi,'*$1*')
          .replace(/<li>(.*?)<\/li>/gi,'- $1\n')
          .replace(/<br\s*\/?>/gi,'\n')
          .replace(/<p[^>]*>(.*?)<\/p>/gi,'$1\n\n')
          .replace(/<\/?[^>]+>/g,'')
          .replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"')
          .replace(/\n{3,}/g,'\n\n').trim();
        restored[pages[pi].idx]=txt;
      }
    }
    /* ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤ */
    ocrS=restored;
    var goodCount=ocrS.filter(function(s){return s&&s.trim()}).length;
    lastStopPage=maxIdx+2; /* ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Ñ‡∏∑‡∏≠ maxIdx+2 (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ idx 0-based, page 1-based) */
    stats={total:0,textExtract:0,ocrApi:goodCount,skipped:maxIdx+1-goodCount};
    tokenUsage={prompt:0,completion:0,total:0};
    chaps=dch(ocrS);
    _resumeMode=true;

    /* ‡∏î‡∏∂‡∏á metadata ‡∏à‡∏≤‡∏Å content.opf */
    try{
      var opfFile=zip.file('OEBPS/content.opf');
      if(opfFile){
        var opfXml=await opfFile.async('string');
        log('üìã ‡∏≠‡πà‡∏≤‡∏ô content.opf ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        var gm=function(tag){var m=opfXml.match(new RegExp('<dc:'+tag+'[^>]*>([\\s\\S]*?)</dc:'+tag+'>','i'));return m?m[1].replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').trim():''};
        var mt=gm('title'),ma=gm('creator'),mp=gm('publisher'),ml=gm('language'),md=gm('description');
        if(mt){$('mt').value=mt;log('üìñ Title: '+mt)}
        if(ma&&ma!=='Unknown'){$('ma').value=ma;log('‚úçÔ∏è Author: '+ma)}
        if(mp)$('mp').value=mp;
        if(ml)$('ml').value=ml;
        if(md)$('md').value=md;
      }else{log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö content.opf','purple')}
    }catch(me){log('‚ö†Ô∏è ‡∏≠‡πà‡∏≤‡∏ô metadata ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+me.message,'error')}

    /* ‡∏î‡∏∂‡∏á‡∏õ‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ */
    try{
      var coverFound=false;
      /* ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏´‡∏≤‡∏à‡∏≤‡∏Å OEBPS/cover.* */
      var coverExts=['jpg','jpeg','png','webp'];
      for(var ci=0;ci<coverExts.length&&!coverFound;ci++){
        var cf=zip.file('OEBPS/cover.'+coverExts[ci]);
        if(cf){
          var cData=await cf.async('base64');
          var cMime=coverExts[ci]==='png'?'image/png':'image/jpeg';
          coverUrl='data:'+cMime+';base64,'+cData;coverMime=cMime;coverFound=true;
        }
      }
      /* ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ "cover" ‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠ */
      if(!coverFound){
        zip.forEach(function(path,entry){
          if(coverFound)return;
          if(path.match(/cover\.(jpg|jpeg|png|webp)$/i)){
            coverFound=true;
            entry.async('base64').then(function(d){
              var ext=path.split('.').pop().toLowerCase();
              var mime=ext==='png'?'image/png':'image/jpeg';
              coverUrl='data:'+mime+';base64,'+d;coverMime=mime;
              $('cz').classList.add('ok');
              var oi=$('cz').querySelector('img');if(oi)oi.remove();
              var ni=document.createElement('img');ni.src=coverUrl;$('cz').appendChild(ni);
              log('üñºÔ∏è ‡∏õ‡∏Å‡∏à‡∏≤‡∏Å EPUB','success');
            });
          }
        });
      }
      if(coverFound&&coverUrl){
        $('cz').classList.add('ok');
        var oldImg=$('cz').querySelector('img');if(oldImg)oldImg.remove();
        var newImg=document.createElement('img');newImg.src=coverUrl;$('cz').appendChild(newImg);
        log('üñºÔ∏è ‡∏õ‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏à‡∏≤‡∏Å EPUB','success');
      }else{log('‚ÑπÔ∏è EPUB ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠','purple')}
    }catch(ce){log('‚ö†Ô∏è ‡∏≠‡πà‡∏≤‡∏ô‡∏õ‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+ce.message,'error')}
    /* ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• */
    $('statbar').classList.add('on');
    updateStats();
    setSt('üìï ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å EPUB: '+goodCount+' ‡∏´‡∏ô‡πâ‡∏≤ ‚Äî ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF ‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Resume ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ '+lastStopPage,'ok');
    log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î '+goodCount+' ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≤‡∏Å EPUB ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ '+lastStopPage,'success');
    /* ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Resume */
    $('bres').style.display='';$('bres').disabled=false;
    $('bres').textContent='‚ñ∂ ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ '+lastStopPage;
  }catch(e){
    setSt('‚ùå ‡∏≠‡πà‡∏≤‡∏ô EPUB ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message,'err');
    log('‚ùå EPUB read error: '+e.message,'error');
  }
  ev.target.value='';
};

/* ‡∏ï‡∏£‡∏ß‡∏à saved progress ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ */
(function(){
  var saved=loadProgress();
  if(!saved||!saved.ocrS||!saved.ocrS.length)return;
  var age=Date.now()-saved.ts;
  if(age>24*60*60*1000){clearProgress();return}
  var good=saved.ocrS.filter(function(s){return s&&s.trim()}).length;
  var timeAgo=age<60000?'‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ':age<3600000?Math.round(age/60000)+' ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß':Math.round(age/3600000)+' ‡∏ä‡∏°.‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';
  setSt('üíæ ‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á: "'+saved.fileName+'" ‚Äî ‡πÑ‡∏î‡πâ '+good+' ‡∏´‡∏ô‡πâ‡∏≤ ('+timeAgo+') ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF ‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Resume','info');
  log('üíæ ‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô localStorage: '+saved.fileName+' ('+good+' ‡∏´‡∏ô‡πâ‡∏≤, '+timeAgo+')','purple');
  /* ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô */
  $('recoverBox').style.display='block';
  $('recoverInfo').textContent='"'+saved.fileName+'" ‚Äî '+good+' ‡∏´‡∏ô‡πâ‡∏≤ ('+timeAgo+') ¬∑ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ PDF ‡∏Å‡πá‡∏™‡∏£‡πâ‡∏≤‡∏á EPUB ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ';
  $('mt').placeholder=saved.fileName.replace(/\.pdf$/i,'');
})();

/* ‚ïê‚ïê‚ïê Recover from localStorage ‚ïê‚ïê‚ïê */
$('bRecover').onclick=async function(){
  var saved=loadProgress();
  if(!saved||!saved.ocrS||!saved.ocrS.length){setSt('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ','err');return}
  try{
    ocrS=saved.ocrS;
    stats=saved.stats||{total:ocrS.length,textExtract:0,ocrApi:0,skipped:0};
    tokenUsage=saved.tokenUsage||{prompt:0,completion:0,total:0};
    chaps=saved.chaps||[];
    if(!chaps.length)chaps=dch(ocrS);
    rtoc();
    var title=$('mt').value.trim()||saved.fileName.replace(/\.pdf$/i,'')||'book';
    $('mt').value=title;
    log('üíæ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: '+ocrS.filter(function(s){return s&&s.trim()}).length+' ‡∏´‡∏ô‡πâ‡∏≤','success');
    setSt('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á EPUB...','info');
    var full=ocrS.filter(function(s){return s&&s.trim()}).join('\n\n--- Page Break ---\n\n');
    var eb=await mke(ocrS,chaps);
    var tb=new Blob(['\ufeff'+full],{type:'text/plain;charset=utf-8'});
    $('de').href=URL.createObjectURL(eb);$('de').download=title+'.epub';$('es').textContent=fs(eb.size);
    $('dt').href=URL.createObjectURL(tb);$('dt').download=title+'.txt';$('ts').textContent=fs(tb.size);
    $('res').classList.add('on');
    $('tocsec').classList.add('on');
    $('statbar').classList.add('on');updateStats();
    $('recoverBox').style.display='none';
    var msg='‚úÖ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! '+ocrS.filter(function(s){return s&&s.trim()}).length+' ‡∏´‡∏ô‡πâ‡∏≤ ‚Äî EPUB ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î';
    setSt(msg,'ok');log('üéâ '+msg,'success');
  }catch(e){setSt('‚ùå '+e.message,'err');log('‚ùå ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô: '+e.message,'error')}
};
$('bRecoverClear').onclick=function(){
  if(!confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏¥‡πâ‡∏á? (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)'))return;
  clearProgress();$('recoverBox').style.display='none';
  setSt('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß','info');log('üóëÔ∏è ‡∏•‡∏ö localStorage','purple');
};

$('tsrow').onclick=function(){var cb=$('tscb'),tog=$('tstog');cb.checked=!cb.checked;if(cb.checked)tog.classList.add('on');else tog.classList.remove('on')};
$('imgrow').onclick=function(){var cb=$('imgcb'),tog=$('imgtog');cb.checked=!cb.checked;if(cb.checked)tog.classList.add('on');else tog.classList.remove('on')};

const dz=$('dz'),fi=$('fi');
dz.onclick=()=>fi.click();
dz.ondragover=e=>{e.preventDefault();dz.classList.add('drag')};
dz.ondragleave=()=>dz.classList.remove('drag');
dz.ondrop=e=>{e.preventDefault();dz.classList.remove('drag');e.dataTransfer.files[0]&&hf(e.dataTransfer.files[0])};
fi.onchange=()=>fi.files[0]&&hf(fi.files[0]);

async function hf(f){
  if(!f.name.toLowerCase().endsWith('.pdf'))return setSt('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô','err');
  pdfFile=f;dz.classList.add('ok');
  $('fn').textContent=`${f.name} (${fs(f.size)})`;
  log('‡πÇ‡∏´‡∏•‡∏î: '+f.name);
  try{
    pdfDoc=await pdfjsLib.getDocument({data:await f.arrayBuffer()}).promise;
    log(`PDF ${pdfDoc.numPages} ‡∏´‡∏ô‡πâ‡∏≤`,'success');
    showPdfPreview();updateCost();
    /* ‡∏î‡∏∂‡∏á metadata ‡∏à‡∏≤‡∏Å PDF */
    try{
      var meta=await pdfDoc.getMetadata();
      var info=meta&&meta.info?meta.info:{};
      if(info.Title&&info.Title.trim()){$('mt').value=info.Title.trim();log('üìñ Title: '+info.Title.trim())}
      else{$('mt').placeholder=f.name.replace(/\.pdf$/i,'')}
      if(info.Author&&info.Author.trim()){$('ma').value=info.Author.trim();log('‚úçÔ∏è Author: '+info.Author.trim())}
      if(info.Producer&&info.Producer.trim()&&!info.Producer.match(/^(Adobe|Microsoft|LibreOffice|macOS|Chrome|Firefox)/i)){$('mp').value=info.Producer.trim()}
      if(info.Subject&&info.Subject.trim()){$('md').value=info.Subject.trim()}
    }catch(me){}
    ck();
  }
  catch(e){log('‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+e.message,'error');setSt('‡∏≠‡πà‡∏≤‡∏ô PDF ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ','err')}
}

$('cz').onclick=()=>$('ci').click();
$('ci').onchange=()=>{const f=$('ci').files[0];if(!f)return;coverMime=f.type;const r=new FileReader();r.onload=e=>{coverUrl=e.target.result;$('cz').classList.add('ok');const o=$('cz').querySelector('img');if(o)o.remove();const i=document.createElement('img');i.src=coverUrl;$('cz').appendChild(i);log('‡∏õ‡∏Å: '+f.name,'success')};r.readAsDataURL(f)};

function cleanKey(k){return k.replace(/[^\x20-\x7E]/g,'').trim()}
function ck(){$('bgo').disabled=!(pdfDoc&&$('ak').value.trim());updateCost()}
$('ak').oninput=function(){this.value=cleanKey(this.value);ck();localStorage.setItem('bepub_apikey',this.value)};
$('ak').onpaste=function(){var self=this;setTimeout(function(){self.value=cleanKey(self.value);ck();localStorage.setItem('bepub_apikey',self.value)},0)};
$('prov').onchange=function(){
  var v=this.value;
  localStorage.setItem('bepub_prov',v);
  if(v==='gemini'){$('ak-lbl').textContent='Gemini API Key';$('ak').placeholder='AIzaSy...'}
  else{$('ak-lbl').textContent='Typhoon API Key';$('ak').placeholder='typhoon-xxxxxxxx'}
  ck();
};
$('tscb').onchange=function(){updateCost()};
$('sp').oninput=function(){updateCost()};
$('ep').oninput=function(){updateCost()};
$('bst').onclick=()=>{isCancelled=true;log('üõë ‡∏´‡∏¢‡∏∏‡∏î','error')};

async function extractText(pageNum){try{var pg=await pdfDoc.getPage(pageNum),tc=await pg.getTextContent(),t='';tc.items.forEach(function(item){if(item.str)t+=item.str;if(item.hasEOL)t+='\n'});return t.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,'').trim()}catch(e){return''}}
function isBlankText(t){if(!t||t.length<5)return true;var c=t.replace(/[\s\d\.\,\-\u2014\u2013\(\)\/\\]/g,'');return c.length<3}
/* Smart image embed: check if page has actual images/illustrations */
async function hasPageImages(pageNum){try{var pg=await pdfDoc.getPage(pageNum),ops=await pg.getOperatorList();for(var i=0;i<ops.fnArray.length;i++){var fn=ops.fnArray[i];if(fn===pdfjsLib.OPS.paintImageXObject||fn===pdfjsLib.OPS.paintJpegXObject||fn===pdfjsLib.OPS.paintImageXObjectRepeat)return true}return false}catch(e){return false}}

async function rp(n,tokenSaver){var d=tokenSaver?800:1600,fmt=tokenSaver?'image/jpeg':'image/png',q=tokenSaver?0.5:undefined;var pg=await pdfDoc.getPage(n),v=pg.getViewport({scale:1}),s=d/Math.max(v.width,v.height),vp=pg.getViewport({scale:s}),c=document.createElement('canvas');c.width=vp.width;c.height=vp.height;await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;var u=q?c.toDataURL(fmt,q):c.toDataURL(fmt);var mime=tokenSaver?'image/jpeg':'image/png';return{b:u.split(',')[1],w:Math.round(vp.width),h:Math.round(vp.height),mime:mime}}

async function ocr(b,w,h,k,tokenSaver,mime){
  var provider=$('prov').value;
  var p=tokenSaver
    ?'image_width: '+w+'\nimage_height: '+h+'\nExtract all text from this page in markdown.'
    :'Below is an image of a document page along with its dimensions.\nimage_width: '+w+'\nimage_height: '+h+'\n\nExtract all the text content from this document page. Maintain the original structure including headings, paragraphs, lists, and tables. Output the result in clean markdown format.';
  var maxTok=tokenSaver?4096:16384;

  if(provider==='gemini'){
    /* Gemini API */
    var r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+k,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({contents:[{parts:[{text:p},{inline_data:{mime_type:mime||'image/png',data:b}}]}],generationConfig:{maxOutputTokens:maxTok,temperature:0.1}})
    });
    if(!r.ok){var eb='';try{eb=await r.text()}catch(x){}var err=new Error('Gemini '+r.status+(eb?': '+eb.substring(0,200):''));err.httpStatus=r.status;throw err}
    var json=await r.json();
    var text=(json.candidates&&json.candidates[0]&&json.candidates[0].content&&json.candidates[0].content.parts)?json.candidates[0].content.parts.map(function(p){return p.text||''}).join(''):'';;
    var um=json.usageMetadata||{};
    var usage={prompt_tokens:um.promptTokenCount||0,completion_tokens:um.candidatesTokenCount||0,total_tokens:um.totalTokenCount||0};
    return{text:text,usage:usage};
  }else{
    /* Typhoon OCR API */
    var imgUrl='data:'+(mime||'image/png')+';base64,'+b;
    var r=await fetch('https://api.opentyphoon.ai/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+k},body:JSON.stringify({model:'typhoon-ocr',messages:[{role:'user',content:[{type:'text',text:p},{type:'image_url',image_url:{url:imgUrl}}]}],max_tokens:maxTok,temperature:0.1})});
    if(!r.ok){var eb='';try{eb=await r.text()}catch(x){}var err=new Error('API '+r.status+(eb?': '+eb.substring(0,200):''));err.httpStatus=r.status;throw err}
    var json=await r.json();
    var text=(json.choices&&json.choices[0]&&json.choices[0].message)?json.choices[0].message.content||'':'';
    var usage=json.usage||{prompt_tokens:0,completion_tokens:0,total_tokens:0};
    return{text:text,usage:usage};
  }
}

async function ocrRetry(b,w,h,k,tokenSaver,mime){
  for(var a=0;a<=3;a++){
    try{return await ocr(b,w,h,k,tokenSaver,mime)}
    catch(e){
      var st=e.httpStatus||0;
      if(st===401){e.fatal=true;e.reason='invalid_key';throw e}
      if(st===402||st===403){e.fatal=true;e.reason='quota_exceeded';throw e}
      if(st===429&&a>=3){e.fatal=true;e.reason='rate_limit';throw e}
      if(st===429){var d=Math.pow(2,a)*2000+Math.random()*1000;log('‚è≥ Rate limit ‚Äî retry '+(a+1)+'/3 ('+(d/1000).toFixed(1)+'s)...','purple');$('pm').textContent='rate limit ‚Äî '+(d/1000).toFixed(0)+'s...';await new Promise(function(r){setTimeout(r,d)});continue}
      if(st>=500&&a<3){var d2=3000+Math.random()*2000;log('‚è≥ Server '+st+' ‚Äî retry...','purple');await new Promise(function(r){setTimeout(r,d2)});continue}
      throw e;
    }
  }
}

function cl(t,cw){let c=t.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F\uFFFE\uFFFF]/g,'');c=c.replace(/<\/?page_number[^>]*>/gi,'').replace(/<page_number>[^<]*<\/page_number>/gi,'').replace(/<[^>]*page_number[^>]*>[^<]*<\/[^>]*>/gi,'');c=c.replace(/\n\*\s*\d+\s*\n/g,'\n').replace(/\*\s*\d+\s*\*/g,'').replace(/\\'/g,'');if(cw)cw.split(',').map(w=>w.trim()).filter(Boolean).forEach(w=>{c=c.split(w).join('')});return c.replace(/\n\s*\n\s*\n/g,'\n\n').normalize('NFC').trim()}

function dch(ss){const ch=[];const ps=[/^(‡∏ö‡∏ó‡∏ó‡∏µ‡πà\s*\d+[^\n]*)/m,/^(‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà\s*\d+[^\n]*)/m,/^(Chapter\s+\d+[^\n]*)/im,/^(‡∏†‡∏≤‡∏Ñ(?:‡∏ó‡∏µ‡πà)?\s*\d+[^\n]*)/m,/^(Part\s+\d+[^\n]*)/im,/^(‡∏ö‡∏ó‡∏ô‡∏≥|‡∏Ñ‡∏≥‡∏ô‡∏≥|‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç|‡∏≠‡∏≤‡∏£‡∏±‡∏°‡∏†‡∏ö‡∏ó|‡∏ö‡∏ó‡∏™‡πà‡∏á‡∏ó‡πâ‡∏≤‡∏¢|‡∏ö‡∏ó‡∏™‡∏£‡∏∏‡∏õ|‡∏†‡∏≤‡∏Ñ‡∏ú‡∏ô‡∏ß‡∏Å|‡∏Ñ‡∏≥‡∏≠‡∏∏‡∏ó‡∏¥‡∏®|‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®)/m,/^#{1,3}\s+(.+)/m];ss.forEach((s,i)=>{if(!s||!s.trim())return;for(const p of ps){const m=s.match(p);if(m){let t=m[1].replace(/^#+\s*/,'').trim();if(t.length>60)t=t.slice(0,60)+'‚Ä¶';if(t.length<2)continue;if(!ch.some(x=>x.title===t&&Math.abs(x.pi-i)<3))ch.push({title:t,pi:i});break}}});return ch}

function rtoc(){const l=$('tocl');l.innerHTML='';if(!chaps.length){$('tocsec').classList.remove('on');return}$('tocsec').classList.add('on');chaps.forEach((c,i)=>{const li=document.createElement('li');li.className='toci';li.innerHTML=`<span class="tn">${i+1}.</span><input value="${esc(c.title)}" data-i="${i}"><span class="tp">p.${c.pi+1}</span><span class="tx" data-i="${i}">‚úï</span>`;l.appendChild(li)});l.querySelectorAll('input').forEach(i=>i.onchange=()=>{chaps[+i.dataset.i].title=i.value});l.querySelectorAll('.tx').forEach(b=>b.onclick=()=>{chaps.splice(+b.dataset.i,1);rtoc()})}
$('bac').onclick=()=>{const p=prompt('‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏ó:');if(!p)return;const n=+p;if(!n||n<1)return;const t=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó:')||`‡∏ö‡∏ó‡∏ó‡∏µ‡πà ${chaps.length+1}`;chaps.push({title:t,pi:n-1});chaps.sort((a,b)=>a.pi-b.pi);rtoc()};

async function mke(ss,ch){
  const z=new JSZip(),m={t:$('mt').value.trim()||pdfFile.name.replace(/\.pdf$/i,''),a:$('ma').value.trim()||'Unknown',p:$('mp').value.trim(),l:$('ml').value.trim()||'th',d:$('md').value.trim()},uid='cattoepub-'+Date.now();
  z.file('mimetype','application/epub+zip',{compression:'STORE'});
  z.file('META-INF/container.xml','<?xml version="1.0"?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>');
  z.file('OEBPS/style.css',`@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;600&display=swap');body{font-family:'IBM Plex Sans Thai',sans-serif;line-height:1.9;padding:1.2em;color:#1a1a1a;max-width:38em;margin:0 auto}h1{font-size:1.6em;margin:1.5em 0 .5em;font-weight:600}h2{font-size:1.3em;margin:1.3em 0 .4em}h3{font-size:1.1em;margin:1.1em 0 .3em}p{margin:.4em 0;text-indent:1.5em;text-align:justify}table{border-collapse:collapse;width:100%;margin:1em 0}td,th{border:1px solid #ddd;padding:.5em .7em}blockquote{border-left:3px solid #ccc;padding-left:1em;color:#555;margin:1em 0}img.cover{max-width:100%;display:block;margin:0 auto}img.page-img{max-width:100%;display:block;margin:1em auto;border:1px solid #eee;border-radius:4px}`);
  let mf='<item id="css" href="style.css" media-type="text/css"/>\n',sp='',nav='',po=1,pfm={};
  if(coverUrl){const ext=coverMime?.includes('png')?'png':'jpg',mt=coverMime||'image/jpeg';z.file(`OEBPS/cover.${ext}`,Uint8Array.from(atob(coverUrl.split(',')[1]),c=>c.charCodeAt(0)));mf+=`<item id="cover-img" href="cover.${ext}" media-type="${mt}"/>\n`;z.file('OEBPS/cover.xhtml',`<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="UTF-8"/><link rel="stylesheet" href="style.css"/></head><body><div style="text-align:center"><img class="cover" src="cover.${ext}" alt="Cover"/></div></body></html>`);mf+=`<item id="cover" href="cover.xhtml" media-type="application/xhtml+xml"/>\n`;sp+=`<itemref idref="cover"/>\n`;nav+=`<navPoint id="cover" playOrder="${po++}"><navLabel><text>‡∏õ‡∏Å</text></navLabel><content src="cover.xhtml"/></navPoint>\n`}
  ss.forEach((s,i)=>{if(!s.trim())return;const fn=`p${i}.xhtml`;pfm[i]=fn;
    /* ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏±‡πâ‡∏¢ */
    var imgTag='';var pi=pageImgs&&pageImgs[i];
    if(pi&&pi.b){
      var ie=pi.m&&pi.m.includes('png')?'png':'jpg';
      var imgFn=`img${i}.${ie}`;
      z.file(`OEBPS/${imgFn}`,Uint8Array.from(atob(pi.b),c=>c.charCodeAt(0)));
      mf+=`<item id="img${i}" href="${imgFn}" media-type="${pi.m||'image/jpeg'}"/>\n`;
      imgTag=`<div style="text-align:center;margin-bottom:1em"><img class="page-img" src="${imgFn}" alt="Page ${i+1}"/></div>`;
    }
    z.file(`OEBPS/${fn}`,`<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="${ex(m.l)}"><head><meta charset="UTF-8"/><link rel="stylesheet" href="style.css"/></head><body>${imgTag}${m2h(s.trim())}</body></html>`);
    mf+=`<item id="p${i}" href="${fn}" media-type="application/xhtml+xml"/>\n`;sp+=`<itemref idref="p${i}"/>\n`
  });
  if(ch.length)ch.forEach((c,i)=>{const fn=pfm[c.pi]||`p${c.pi}.xhtml`;nav+=`<navPoint id="ch${i}" playOrder="${po++}"><navLabel><text>${ex(c.title)}</text></navLabel><content src="${fn}"/></navPoint>\n`});
  else ss.forEach((s,i)=>{if(s.trim())nav+=`<navPoint id="n${i}" playOrder="${po++}"><navLabel><text>‡∏´‡∏ô‡πâ‡∏≤ ${i+1}</text></navLabel><content src="p${i}.xhtml"/></navPoint>\n`});
  let mx=`<dc:title>${ex(m.t)}</dc:title><dc:language>${ex(m.l)}</dc:language><dc:identifier id="uid">${uid}</dc:identifier><dc:creator>${ex(m.a)}</dc:creator>`;
  if(m.p)mx+=`<dc:publisher>${ex(m.p)}</dc:publisher>`;if(m.d)mx+=`<dc:description>${ex(m.d)}</dc:description>`;if(coverUrl)mx+=`<meta name="cover" content="cover-img"/>`;
  z.file('OEBPS/content.opf',`<?xml version="1.0" encoding="UTF-8"?><package xmlns="http://www.idpf.org/2007/opf" version="2.0" unique-identifier="uid"><metadata xmlns:dc="http://purl.org/dc/elements/1.1/">${mx}</metadata><manifest>${mf}<item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/></manifest><spine toc="ncx">${sp}</spine></package>`);
  z.file('OEBPS/toc.ncx',`<?xml version="1.0" encoding="UTF-8"?><ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1"><head><meta name="dtb:uid" content="${uid}"/></head><docTitle><text>${ex(m.t)}</text></docTitle><navMap>${nav}</navMap></ncx>`);
  return z.generateAsync({type:'blob',mimeType:'application/epub+zip'});
}

function m2h(md){let h=eh(md.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,''));h=h.replace(/^(\|.+\|)\n(\|[-| :]+\|)\n((?:\|.+\|\n?)+)/gm,(_,hd,_s,bd)=>{const ths=hd.split('|').filter(c=>c.trim()).map(c=>`<th>${c.trim()}</th>`).join('');const rows=bd.trim().split('\n').map(r=>`<tr>${r.split('|').filter(c=>c.trim()).map(c=>`<td>${c.trim()}</td>`).join('')}</tr>`).join('');return`<table><thead><tr>${ths}</tr></thead><tbody>${rows}</tbody></table>`});h=h.replace(/^### (.+)$/gm,'<h3>$1</h3>');h=h.replace(/^## (.+)$/gm,'<h2>$1</h2>');h=h.replace(/^# (.+)$/gm,'<h1>$1</h1>');h=h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');h=h.replace(/\*(.+?)\*/g,'<em>$1</em>');h=h.replace(/^&gt;\s?(.+)$/gm,'<blockquote>$1</blockquote>');h=h.replace(/^[-*]\s+(.+)$/gm,'<li>$1</li>');h=h.replace(/((?:<li>.+<\/li>\n?)+)/g,'<ul>$1</ul>');return h.split(/\n\n+/).map(p=>{p=p.trim();if(!p)return'';if(/^<(h[1-3]|table|ul|blockquote)/.test(p))return p;return`<p>${p.replace(/\n/g,'<br/>')}</p>`}).join('\n')}
function eh(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function ex(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function esc(s){return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;')}

$('brb').onclick=async()=>{if(!ocrS.length)return setSt('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','err');log('üîÑ Rebuild...');try{const b=await mke(ocrS,chaps);const nm=$('mt').value.trim()||pdfFile.name.replace(/\.pdf$/i,'');$('de').href=URL.createObjectURL(b);$('de').download=nm+'.epub';$('es').textContent=fs(b.size);setSt('‚úÖ EPUB ‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß','ok');log('‚úÖ Done','success')}catch(e){setSt('‚ùå '+e.message,'err');log(e.message,'error')}};

var _resumeMode=false;
$('bgo').onclick=function(){_resumeMode=false;startProcess().catch(function(e){log('‚ùå ‡∏£‡∏∞‡∏ö‡∏ö: '+e.message,'error');setSt('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+e.message,'err');isProc=false;$('bgo').disabled=false;$('bst').disabled=true})};
$('bres').onclick=function(){_resumeMode=true;startProcess().catch(function(e){log('‚ùå ‡∏£‡∏∞‡∏ö‡∏ö: '+e.message,'error');setSt('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+e.message,'err');isProc=false;$('bgo').disabled=false;$('bst').disabled=true})};

async function startProcess(){
  if(isProc)return;isProc=true;isCancelled=false;
  if('Notification' in window&&Notification.permission==='default')Notification.requestPermission();
  try{
  var tokenSaver=$('tscb').checked;
  var key=cleanKey($('ak').value),origStart=Math.max(1,+$('sp').value||1),e0=+$('ep').value||0,tot=pdfDoc.numPages,end=(e0===0||e0>tot)?tot:e0,cw=$('cr').value;

  if(!_resumeMode){
    /* ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ saved progress ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á fileName ‡∏°‡∏±‡πâ‡∏¢ */
    var saved=loadProgress();
    if(saved&&saved.fileName===pdfFile.name&&saved.ocrS&&saved.ocrS.length){
      ocrS=saved.ocrS;stats=saved.stats;tokenUsage=saved.tokenUsage;lastStopPage=saved.lastStopPage;chaps=saved.chaps||[];
      _resumeMode=true;log('üíæ ‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á: '+ocrS.filter(function(s){return s&&s.trim()}).length+' ‡∏´‡∏ô‡πâ‡∏≤','success');
    }else{
      ocrS=[];pageImgs=[];tokenUsage={prompt:0,completion:0,total:0};lastStopPage=0;stats={total:end-origStart+1,textExtract:0,ocrApi:0,skipped:0};clearProgress();
    }
  }

  /* ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì s0 ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å load progress ‡πÅ‡∏•‡πâ‡∏ß */
  var s0=(_resumeMode&&lastStopPage>0)?lastStopPage:origStart;
  if(_resumeMode&&stats.total===0)stats.total=end-origStart+1;
  if(s0>end){setSt('‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô > ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î','err');isProc=false;return}

  $('bgo').disabled=true;$('bst').disabled=false;$('bres').style.display='none';$('bres').disabled=true;
  $('res').classList.remove('on');$('tocsec').classList.remove('on');
  $('prg').classList.add('on','run');$('statbar').classList.add('on');
  setSt('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏ô‡πâ‡∏≤ '+s0+'‚Äì'+end+(tokenSaver?' (Token Saver ON)':'')+(_resumeMode?' [Resume]':''),'info');

  var base=$('mt').value.trim()||pdfFile.name.replace(/\.pdf$/i,'');
  var full='',cnt=stats.total,done=ocrS.length;
  updateStats();
  for(var ri=0;ri<ocrS.length;ri++){if(ocrS[ri])full+=ocrS[ri]+'\n\n--- Page Break ---\n\n'}

  log('‡πÄ‡∏£‡∏¥‡πà‡∏°: '+s0+'‚Äì'+end+(_resumeMode?' [Resume]':' ('+cnt+' ‡∏´‡∏ô‡πâ‡∏≤)')+(tokenSaver?' üíé':''));

  var consErr=0,fatalErr=null;
  var PARALLEL=tokenSaver?5:3;
  var batchStartTime=0;

  /* ===== pre-render cache ===== */
  var preCache={};
  async function preRender(pages,ts){
    var out={};for(var i=0;i<pages.length;i++){
      if(preCache[pages[i]]){out[pages[i]]=preCache[pages[i]];continue}
      out[pages[i]]=rp(pages[i],ts);
    }
    for(var k in out) out[k]=await out[k];
    return out;
  }

  /* ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• 1 ‡∏´‡∏ô‡πâ‡∏≤ (‡πÉ‡∏ä‡πâ preCache ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) */
  var embedImgs=$('imgcb').checked;
  async function processPage(p){
    var result={page:p,text:'',method:'',usage:null,skip:false,blank:false,imgB64:null,imgMime:null};
    if(tokenSaver){
      var extracted=await extractText(p);
      var cleanExt=extracted.replace(/[\s\d\.\,\-\u2014\u2013\(\)\/\\]/g,'');
      if(cleanExt.length>=30){
        result.text=extracted;result.method='text';
        /* Smart embed: page has text layer = digital PDF ‚Üí embed only actual illustrations */
        if(embedImgs&&await hasPageImages(p)){var ei=preCache[p]||await rp(p,true);delete preCache[p];result.imgB64=ei.b;result.imgMime=ei.mime}
      }else if(extracted.length>0&&isBlankText(extracted)){
        result.skip=true;
      }else{
        /* No text layer ‚Üí scanned page (image IS the page) ‚Üí NEVER embed */
        var img=preCache[p]||await rp(p,true);delete preCache[p];
        var res=await ocrRetry(img.b,img.w,img.h,key,true,img.mime);
        result.text=cl(res.text,cw);result.method='ocr';result.usage=res.usage;
      }
    }else{
      /* Check if page has text layer before deciding to embed */
      var hasText=false;
      try{var ext=await extractText(p);hasText=ext.replace(/[\s\d\.\,\-\(\)\/\\]/g,'').length>=30}catch(e){}
      var img2=preCache[p]||await rp(p,false);delete preCache[p];
      /* Only embed images if page has text (=digital PDF with illustrations, not scanned) */
      if(embedImgs&&hasText&&await hasPageImages(p)){result.imgB64=img2.b;result.imgMime=img2.mime}
      var res2=await ocrRetry(img2.b,img2.w,img2.h,key,false,img2.mime);
      result.text=cl(res2.text,cw);result.method='ocr';result.usage=res2.usage;
    }
    return result;
  }

  /* ===== ‡∏ß‡∏ô batch ===== */
  for(var p=s0;p<=end;){
    if(isCancelled){lastStopPage=p;break}
    if(fatalErr||consErr>=3)break;

    /* ‡∏™‡∏£‡πâ‡∏≤‡∏á batch */
    var batch=[];
    for(var bi=0;bi<PARALLEL&&p+bi<=end;bi++)batch.push(p+bi);
    var batchSize=batch.length;

    $('pt').textContent=(tokenSaver?'üíé':'üîç')+' ‡∏´‡∏ô‡πâ‡∏≤ '+batch[0]+(batchSize>1?'‚Äì'+batch[batch.length-1]:'')+'/'+end;
    var pct=Math.round(done/cnt*100);$('pp').textContent=pct+'%';$('pb').style.width=pct+'%';
    batchStartTime=Date.now();

    /* pre-render ‡∏ó‡∏±‡πâ‡∏á batch ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô + batch ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ */
    var nextBatch=[];for(var ni=p+batchSize;ni<p+batchSize+PARALLEL&&ni<=end;ni++)nextBatch.push(ni);
    var preRenderPromise=nextBatch.length?preRender(nextBatch,tokenSaver):null;

    /* ‡∏£‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô */
    var promises=batch.map(function(pg){return processPage(pg).then(function(r){return{ok:true,r:r}}).catch(function(e){return{ok:false,page:pg,err:e}})});
    var results=await Promise.all(promises);

    /* ‡πÄ‡∏Å‡πá‡∏ö pre-render ‡∏Ç‡∏≠‡∏á batch ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ */
    if(preRenderPromise){try{var pre=await preRenderPromise;for(var pk in pre)preCache[pk]=pre[pk]}catch(e){}}

    /* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ */
    var batchMs=Date.now()-batchStartTime;
    var secPerPage=(batchMs/batchSize/1000).toFixed(1);
    var remain=end-p-batchSize+1;
    var eta=remain>0?Math.round(remain*(batchMs/batchSize)/1000):0;
    var etaStr=eta>60?Math.floor(eta/60)+'m '+eta%60+'s':eta+'s';
    $('pm').textContent=secPerPage+'s/‡∏´‡∏ô‡πâ‡∏≤'+(remain>0?' ¬∑ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ~'+etaStr:'');

    /* ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏±‡∏ß (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö) */
    for(var ri=0;ri<results.length;ri++){
      if(isCancelled){lastStopPage=batch[ri];break}
      var item=results[ri];
      if(item.ok){
        var r=item.r;
        if(r.skip){
          stats.skipped++;ocrS.push('');pageImgs.push(null);done++;consErr=0;
          log('‚è≠Ô∏è ‡∏´‡∏ô‡πâ‡∏≤ '+r.page+': ‡∏ß‡πà‡∏≤‡∏á ‚Äî ‡∏Ç‡πâ‡∏≤‡∏°','purple');
        }else if(r.text){
          var t=r.method==='text'?cl(r.text,cw):r.text;
          ocrS.push(t);pageImgs.push(r.imgB64?{b:r.imgB64,m:r.imgMime}:null);full+=t+'\n\n--- Page Break ---\n\n';done++;consErr=0;
          if(r.method==='text'){stats.textExtract++;log('‚úÖ ‡∏´‡∏ô‡πâ‡∏≤ '+r.page+': Text ('+t.length+' chars) ‚Äî ‡∏ü‡∏£‡∏µ!'+(r.imgB64?' üñºÔ∏è':''),'success')}
          else{stats.ocrApi++;
            if(r.usage){tokenUsage.prompt+=(r.usage.prompt_tokens||0);tokenUsage.completion+=(r.usage.completion_tokens||0);tokenUsage.total+=(r.usage.total_tokens||0)}
            log('‚úÖ ‡∏´‡∏ô‡πâ‡∏≤ '+r.page+': OCR ('+t.length+' chars'+(r.usage?', '+r.usage.total_tokens+' tok':'')+')'+(r.imgB64?' üñºÔ∏è':''),'success');
          }
        }else{ocrS.push('');pageImgs.push(null);done++;log('‚ö†Ô∏è ‡∏´‡∏ô‡πâ‡∏≤ '+r.page+': ‡∏ß‡πà‡∏≤‡∏á','error')}
      }else{
        ocrS.push('');pageImgs.push(null);done++;consErr++;
        log('‚ùå ‡∏´‡∏ô‡πâ‡∏≤ '+item.page+': '+item.err.message,'error');
        if(item.err.fatal){
          fatalErr=item.err;lastStopPage=item.page+1;
          var reasons={'invalid_key':'üîë API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','quota_exceeded':'üí≥ Token/Credit ‡∏´‡∏°‡∏î','rate_limit':'üö´ Rate limit'};
          log((reasons[item.err.reason]||'‚ùå Fatal')+' ‚Äî ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ','error');break;
        }
        if(consErr>=3){lastStopPage=item.page+1;log('üõë Error '+consErr+' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡∏¥‡∏î ‚Äî ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥','error');break}
      }
      updateStats();
    }
    p+=batchSize;
    saveProgress(pdfFile.name);
  }

  $('pb').style.width='100%';$('pp').textContent='100%';$('prg').classList.remove('run');$('pm').textContent='';

  var hasContent=full.trim().length>0;
  if(hasContent){
    try{
      chaps=dch(ocrS);rtoc();
      var eb=await mke(ocrS,chaps),tb=new Blob(['\ufeff'+full],{type:'text/plain;charset=utf-8'});
      $('de').href=URL.createObjectURL(eb);$('de').download=base+'.epub';$('es').textContent=fs(eb.size);
      $('dt').href=URL.createObjectURL(tb);$('dt').download=base+'.txt';$('ts').textContent=fs(tb.size);
      $('res').classList.add('on');$('pvsec').style.display='block';$('editBtn').style.display='block';
      $('pvb').textContent=full.substring(0,5000)+(full.length>5000?'\n‚Ä¶(5,000 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏£‡∏Å)':'');
    }catch(e){log('EPUB: '+e.message,'error')}
  }

  var stopped=!!fatalErr||isCancelled||consErr>=3;
  var goodPages=ocrS.filter(function(s){return s.trim()}).length;
  var tokStr=tokenUsage.total>0?' ¬∑ üéØ '+tokenUsage.total.toLocaleString()+' tokens':'';

  if(!stopped){
    var savedPct=stats.total>0?Math.round((stats.textExtract+stats.skipped)/stats.total*100):0;
    var msg='‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! '+goodPages+' ‡∏´‡∏ô‡πâ‡∏≤'+tokStr;
    if(tokenSaver&&savedPct>0)msg+=' ¬∑ üíé ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î '+savedPct+'%';
    setSt(msg,'ok');log('üéâ '+msg,'success');clearProgress();
    sendNotif('CattoEPUB ‚úÖ',msg);
    playSound();recordUsage(goodPages,tokenUsage.total);
  }else{
    var stopReason=isCancelled?'‡∏´‡∏¢‡∏∏‡∏î‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ':fatalErr?(fatalErr.reason==='invalid_key'?'üîë Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á':fatalErr.reason==='quota_exceeded'?'üí≥ Token ‡∏´‡∏°‡∏î':'üö´ Rate limit'):'Error '+consErr+' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡∏¥‡∏î';
    var msg2=stopReason+' ‚Äî ‡πÑ‡∏î‡πâ '+goodPages+'/'+stats.total+' ‡∏´‡∏ô‡πâ‡∏≤'+tokStr+(hasContent?' (EPUB ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î)':'');
    setSt(msg2,fatalErr&&fatalErr.reason==='invalid_key'?'err':'info');
    log(msg2,fatalErr?'error':'purple');
    sendNotif('CattoEPUB',msg2);
  }

  if(stopped&&lastStopPage>0&&lastStopPage<=end){
    $('bres').style.display='';$('bres').disabled=false;
    $('bres').textContent='‚ñ∂ ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ '+lastStopPage;
  }
  if(isCancelled&&!lastStopPage){
    lastStopPage=s0+done;
    if(lastStopPage<=end){$('bres').style.display='';$('bres').disabled=false;$('bres').textContent='‚ñ∂ ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ '+lastStopPage}
  }

  }catch(topErr){
    log('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á: '+topErr.message,'error');setSt('‚ùå '+topErr.message,'err');console.error('startProcess error:',topErr);
  }finally{
    $('bgo').disabled=false;$('bst').disabled=true;isProc=false;
  }
}

function fs(b){return b<1024?b+' B':b<1048576?(b/1024).toFixed(1)+' KB':(b/1048576).toFixed(1)+' MB'}

/* ‚ïê‚ïê‚ïê Edit OCR Modal ‚ïê‚ïê‚ïê */
var _edtIdx=0;
function openEditModal(idx){
  if(!ocrS.length)return;
  if(idx<0)idx=0;if(idx>=ocrS.length)idx=ocrS.length-1;
  _edtIdx=idx;
  $('edtPageNum').textContent=(idx+1);
  $('edtTa').value=ocrS[idx]||'';
  $('edtPageInfo').textContent=(idx+1)+' / '+ocrS.length;
  $('edtOverlay').classList.add('on');
  $('edtTa').focus();
}
function closeEditModal(){$('edtOverlay').classList.remove('on')}
$('edtClose').onclick=closeEditModal;
$('edtCancel').onclick=closeEditModal;
$('edtSave').onclick=function(){
  ocrS[_edtIdx]=$('edtTa').value;
  if(pdfFile)saveProgress(pdfFile.name);
  closeEditModal();
  log('‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡πâ‡∏≤ '+(_edtIdx+1)+' ‡πÅ‡∏•‡πâ‡∏ß','success');
  setSt('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡πâ‡∏≤ '+(_edtIdx+1)+' ‡πÅ‡∏•‡πâ‡∏ß','ok');
};
$('edtOverlay').onclick=function(e){if(e.target===$('edtOverlay'))closeEditModal()};
$('edtPrev').onclick=function(){if(_edtIdx>0){ocrS[_edtIdx]=$('edtTa').value;openEditModal(_edtIdx-1)}};
$('edtNext').onclick=function(){if(_edtIdx<ocrS.length-1){ocrS[_edtIdx]=$('edtTa').value;openEditModal(_edtIdx+1)}};
$('bEdit').onclick=function(){if(ocrS.length)openEditModal(0)};

/* ‚ïê‚ïê‚ïê Sound Notification ‚ïê‚ïê‚ïê */
function playSound(){
  try{
    var ctx=new(window.AudioContext||window.webkitAudioContext)();
    var o=ctx.createOscillator(),g=ctx.createGain();
    o.connect(g);g.connect(ctx.destination);
    o.type='sine';o.frequency.setValueAtTime(587,ctx.currentTime);
    g.gain.setValueAtTime(0.3,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.5);
    o.start(ctx.currentTime);o.stop(ctx.currentTime+0.5);
    var o2=ctx.createOscillator(),g2=ctx.createGain();
    o2.connect(g2);g2.connect(ctx.destination);
    o2.type='sine';o2.frequency.setValueAtTime(784,ctx.currentTime+0.15);
    g2.gain.setValueAtTime(0.3,ctx.currentTime+0.15);
    g2.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.65);
    o2.start(ctx.currentTime+0.15);o2.stop(ctx.currentTime+0.65);
  }catch(e){}
}

/* ‚ïê‚ïê‚ïê Keyboard Shortcuts ‚ïê‚ïê‚ïê */
document.addEventListener('keydown',function(e){
  if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){
    e.preventDefault();
    if(!$('bgo').disabled)$('bgo').click();
  }
  if(e.key==='Escape'){
    if($('edtOverlay').classList.contains('on')){closeEditModal();return}
    if(isProc){isCancelled=true;log('üõë ‡∏´‡∏¢‡∏∏‡∏î (Esc)','error')}
  }
});

/* ‚ïê‚ïê‚ïê Usage Stats (All-time) ‚ïê‚ïê‚ïê */
var US_KEY='bepub_usage';
function loadUsage(){try{return JSON.parse(localStorage.getItem(US_KEY))||{sessions:0,pages:0,tokens:0}}catch(e){return{sessions:0,pages:0,tokens:0}}}
function saveUsage(u){try{localStorage.setItem(US_KEY,JSON.stringify(u))}catch(e){}}
function updateUsageDisplay(){
  var u=loadUsage();
  if(u.sessions||u.pages||u.tokens){
    $('ustats').textContent='üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°: '+u.sessions+' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ¬∑ '+u.pages+' ‡∏´‡∏ô‡πâ‡∏≤ ¬∑ '+u.tokens.toLocaleString()+' tokens';
    $('ustats').style.display='block';
  }
}
function recordUsage(pages,tokens){
  var u=loadUsage();
  u.sessions++;u.pages+=pages;u.tokens+=tokens;
  saveUsage(u);updateUsageDisplay();
}
updateUsageDisplay();

/* ‚ïê‚ïê‚ïê PWA Service Worker ‚ïê‚ïê‚ïê */
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').catch(function(){})}
</script>
</body>
</html>
